<!doctype html><html class=h-full lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="tl;dr: Use waitress instead of gunicorn diff --git a/Procfile b/Procfile index d49e1a0..0cd38da 100644 --- a/Procfile +++ b/Procfile @@ -1 +1 @@ -web: gunicorn &#34;app:create_app()&#34; +web: waitress-serve --port=$PORT --threads=${WEB_CONCURRENCY:-2} --call 'app:create_app' Recently, I had trouble deploying a Flask application using gunicorn as the WSGI server on a Heroku&rsquo;s free dyno tier.">
<meta name=deploy-date content="2022-03-03">
<meta name=publish-date content="2020-10-11">
<meta name=last-modified-date content="2021-04-24">
<meta name=author content>
<meta name=color-scheme content="dark light">
<link rel=icon href=/favicon.ico sizes=any>
<link rel=icon href=/icon.svg type=image/svg+xml>
<link rel=apple-touch-icon href=/apple-touch-icon.png>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather&family=Fira+Sans&display=swap" rel=stylesheet>
<link rel=stylesheet href="/css/main.min.css">
<link rel=stylesheet href=/css/dark-syntax-highlight.min.css>
<title>
Deploying a Flask app on a Heroku free dyno | Phelipe Teles
</title>
<meta property="og:title" content="Deploying a Flask app on a Heroku free dyno">
<meta property="og:description" content="tl;dr: Use waitress instead of gunicorn diff --git a/Procfile b/Procfile index d49e1a0..0cd38da 100644 --- a/Procfile +++ b/Procfile @@ -1 +1 @@ -web: gunicorn &#34;app:create_app()&#34; +web: waitress-serve --port=$PORT --threads=${WEB_CONCURRENCY:-2} --call 'app:create_app' Recently, I had trouble deploying a Flask application using gunicorn as the WSGI server on a Heroku&rsquo;s free dyno tier.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://phelipetls.github.io/posts/deploying-flask-app-on-heroku/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-10-11T00:00:00+00:00">
<meta property="article:modified_time" content="2021-04-24T13:17:50-03:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Deploying a Flask app on a Heroku free dyno">
<meta name=twitter:description content="tl;dr: Use waitress instead of gunicorn diff --git a/Procfile b/Procfile index d49e1a0..0cd38da 100644 --- a/Procfile +++ b/Procfile @@ -1 +1 @@ -web: gunicorn &#34;app:create_app()&#34; +web: waitress-serve --port=$PORT --threads=${WEB_CONCURRENCY:-2} --call 'app:create_app' Recently, I had trouble deploying a Flask application using gunicorn as the WSGI server on a Heroku&rsquo;s free dyno tier.">
</head>
<body data-preload class="h-full text-foreground bg-background transition transition-colors duration-500 ease-out">
<script>function storeTheme(a){a&&localStorage.setItem('__theme',a)}function getStoredTheme(){return localStorage.getItem('__theme')}function setTheme(a){a==='auto'&&window.matchMedia('(prefers-color-scheme: dark)').matches&&(a='dark'),a==='dark'?document.body.classList.add('dark'):document.body.classList.remove('dark')}function dispatchNewThemeEvent(a){const b=new CustomEvent('newTheme',{detail:{theme:a}});document.body.dispatchEvent(b)}window.__setTheme=function(a){setTheme(a),storeTheme(a),dispatchNewThemeEvent(a)};const storedTheme=getStoredTheme()||'auto';window.__setTheme(storedTheme),window.addEventListener('load',function(){document.body.removeAttribute('data-preload'),dispatchNewThemeEvent(storedTheme)})</script>
<div data-scroll-container class="flex flex-col min-h-full">
<div data-nav-container class="sticky bg-background bg-opacity-90 backdrop-filter backdrop-blur-sm top-0 my-4 py-4 flex-shrink-0 z-30 will-change-transform transition-transform duration-200 ease-linear" style=transform:translateY(0%)>
<div class="flex items-center justify-between mx-auto max-w-prose px-4">
<nav aria-label="Main navigation">
<div class="flex flex-row flex-wrap gap-2"><a href=https://phelipetls.github.io/>
About
</a><a class=border-primary href=https://phelipetls.github.io/posts/>
Posts
</a><a href=https://phelipetls.github.io/projects/>
Projects
</a><a href=https://phelipetls.github.io/embedded-resume/>
Resum√©
</a></div>
</nav>
<button data-theme-button class="p-1 btn btn-icon" aria-label="Change theme" aria-expanded=false aria-controls=theme-menu aria-haspopup=true><svg width="24" height="24" viewBox="0 0 24 24"><title>Theme icon</title><defs><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><svg id="monitor" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
</defs>
<use data-theme-button-svg-icon href=#sun>
</svg>
</button>
<ul data-theme-menu id=theme-menu class="absolute bg-background border border-divider rounded z-50 shadow-xl shadow-divider/50 flex flex-col list-none m-0" style=visibility:hidden;opacity:0;pointer-events:none role=menu aria-orientation=vertical aria-activedescendant=theme-option-auto aria-label="Theme options" tabindex=-1>
<li class="px-2 py-1 m-0 cursor-pointer flex items-center gap-1" id=theme-option-light data-theme=light role=menuitem tabindex=-1><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
Light
</li>
<li class="px-2 py-1 m-0 cursor-pointer flex items-center gap-1" id=theme-option-dark data-theme=dark role=menuitem tabindex=-1><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
Dark
</li>
<li class="px-2 py-1 m-0 cursor-pointer flex items-center gap-1" id=theme-option-auto data-theme=auto role=menuitem tabindex=-1><svg id="monitor" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
System
</li>
</ul>
</div>
</div>
<div class="my-8 px-4 flex-1 max-w-prose flex flex-col container mx-auto">
<main class="flex flex-1 flex-col">
<article>
<header>
<div class=mb-2>
<time class="uppercase text-sm" datetime=2020-10-11>
October 11, 2020
</time>
</div>
<h1 class="text-4xl mb-4">
Deploying a Flask app on a Heroku free dyno
</h1>
<div class="text-sm mb-4 italic">
Last modified at
<time datetime=2021-04-24>
April 24, 2021
</time>
</div>
</header>
<div class=mb-4>
<a href=/tags/python/ class="no-underline rounded-full border-2 px-2">python</a>
<a href=/tags/flask/ class="no-underline rounded-full border-2 px-2">flask</a>
<a href=/tags/heroku/ class="no-underline rounded-full border-2 px-2">heroku</a>
</div>
<hr class=my-8>
<p>tl;dr: Use
<a href=https://docs.pylonsproject.org/projects/waitress/en/latest/>waitress</a>
instead
of <a href=https://gunicorn.org/>gunicorn</a>
</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=gh>diff --git a/Procfile b/Procfile
</span><span class=gh>index d49e1a0..0cd38da 100644
</span><span class=gh></span><span class=gd>--- a/Procfile
</span><span class=gd></span><span class=gi>+++ b/Procfile
</span><span class=gi></span><span class=gu>@@ -1 +1 @@
</span><span class=gu></span><span class=gd>-web: gunicorn &#34;app:create_app()&#34;
</span><span class=gd></span><span class=gi>+web: waitress-serve --port=$PORT --threads=${WEB_CONCURRENCY:-2} --call &#39;app:create_app&#39;
</span></code></pre></div><p>Recently, I had trouble deploying a Flask application using gunicorn as the WSGI
server on a Heroku&rsquo;s free dyno tier.</p>
<p>The problem boils down to the application not restarting when the dyno is
unidling, so once it sleeps it never wakes up again, unless you force it to do
so with <code>heroku restart</code>.</p>
<p>From the <code>heroku logs</code>:</p>
<pre><code>2020-08-27T19:21:21.060020+00:00 heroku[web.1]: State changed from down to starting
2020-08-27T19:21:26.527757+00:00 heroku[web.1]: Starting process with command `gunicorn &quot;app:create_app()&quot;`
2020-08-27T19:21:34.069516+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [4] [INFO] Starting gunicorn 20.0.4
2020-08-27T19:21:34.087317+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [4] [INFO] Listening at: http://0.0.0.0:3906 (4)
2020-08-27T19:21:34.092921+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [4] [INFO] Using worker: sync
2020-08-27T19:21:34.131957+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [10] [INFO] Booting worker with pid: 10
2020-08-27T19:21:34.201582+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [11] [INFO] Booting worker with pid: 11
2020-08-27T19:21:34.560508+00:00 heroku[web.1]: State changed from starting to up
2020-08-27T19:54:54.137845+00:00 heroku[web.1]: Idling
2020-08-27T19:54:54.139855+00:00 heroku[web.1]: State changed from up to down
2020-08-27T19:54:59.841651+00:00 heroku[web.1]: Stopping all processes with SIGTERM
2020-08-27T19:54:59.908237+00:00 app[web.1]: [2020-08-27 19:54:59 +0000] [11] [INFO] Worker exiting (pid: 11)
2020-08-27T19:54:59.910662+00:00 app[web.1]: [2020-08-27 19:54:59 +0000] [4] [INFO] Handling signal: term
2020-08-27T19:54:59.919059+00:00 app[web.1]: [2020-08-27 19:54:59 +0000] [10] [INFO] Worker exiting (pid: 10)
2020-08-27T19:55:00.122579+00:00 app[web.1]: [2020-08-27 19:55:00 +0000] [4] [INFO] Shutting down: Master
2020-08-27T19:55:00.223868+00:00 heroku[web.1]: Process exited with status 0
</code></pre>
<p>Every request would then be met with a Heroku <code>H10</code> error and 503 HTTP error.</p>
<p>I simply had this in my <code>Procfile</code>:</p>
<pre><code>web: gunicorn &quot;app:create_app()&quot;
</code></pre>
<p>I don&rsquo;t know if there&rsquo;s anything wrong with it or if I could have done something
to make it restart when unidling. Please let me know if that&rsquo;s the case.</p>
<p>By comparing with a node application log, the difference seems to be on how the
processes handle a <code>SIGTERM</code> signal. <code>node</code> exits with code 143 and restarts
just fine afterwards, but <code>gunicorn</code> exits with code 0 and doesn&rsquo;t restart
again.</p>
<p>I searched for a way to configure how gunicorn handles SIGTERM with no luck, but
that would be too awkward anyway.</p>
<p>Then I stumbled upon
<a href=https://blog.etianen.com/blog/2014/01/19/gunicorn-heroku-django/>a post discouraging the use of gunicorn on Heroku</a>
and recommending
<a href=https://docs.pylonsproject.org/projects/waitress/en/latest/>Waitress</a>
instead.</p>
<p>The mentioned blog post author&rsquo;s reasons are much more technical than mine, I
just wanted the application to not crash. So I changed the Procfile to:</p>
<pre><code>web: waitress-serve --port=$PORT --threads=${WEB_CONCURRENCY:-2} --call 'app:create_app'
</code></pre>
<p>As was suggested by the
<a href=https://flask.palletsprojects.com/en/1.1.x/tutorial/deploy/#run-with-a-production-server>Flask</a>
and
<a href=https://docs.pylonsproject.org/projects/waitress/en/latest/usage.html#heroku>Waitress documentation</a>
</p>
<p>Now the application restarts when unidling:</p>
<pre><code>2020-10-09T02:02:24.121855+00:00 heroku[web.1]: Idling
2020-10-09T02:02:24.123702+00:00 heroku[web.1]: State changed from up to down
2020-10-09T02:02:25.226026+00:00 heroku[web.1]: Stopping all processes with SIGTERM
2020-10-09T02:02:25.317332+00:00 heroku[web.1]: Process exited with status 143
2020-10-09T13:22:44.966887+00:00 heroku[web.1]: Unidling
2020-10-09T13:22:44.969344+00:00 heroku[web.1]: State changed from down to starting
2020-10-09T13:22:49.127433+00:00 heroku[web.1]: Starting process with command `waitress-serve --port=55574 --threads=${WEB_CONCURRENCY:-2} --call 'app:create_app'`
</code></pre>
</article>
<hr class=my-8>
<nav class="flex justify-between flex-wrap sm:flex-nowrap gap-2" aria-label="Posts navigation">
<a class="flex basis-1/2 grow items-center gap-2 border-0" href=/posts/vim-errorformat-for-pytest/ title="Previous post">
<span class=text-primary><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
</span>
A Vim errorformat for pytest
</a>
<a class="flex basis-1/2 grow items-center self-end text-right mt-2 sm:mt-0 h-full justify-end gap-2 border-0" href=/posts/f-strings-syntax-highlighting-in-vim/ title="Next post">
Python f-strings syntax highlighting in Vim
<span class=text-primary><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
</span>
</a>
</nav>
</main>
</div>
<footer class="flex flex-col py-8 gap-2">
<div class="flex flex-wrap justify-center">
<nav class="flex gap-2 order-last sm:order-first" aria-label=Links>
<a href=mailto:phelipe_teles@hotmail.com title=E-mail>
E-mail
</a>
<a href=https://linkedin.com/in/phelipeteles title=LinkedIn>
LinkedIn
</a>
<a href=https://github.com/phelipetls title=GitHub>
GitHub
</a>
</nav>
</div>
<p class=text-center>
This content is under a
<a rel=license href=http://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0</a>
license.
</p>
</footer>
</div>
<script type=module src=https://phelipetls.github.io/js/theme-button.min.js></script>
<script type=module src=https://phelipetls.github.io/js/nav.min.js></script>
</body>
</html>