<!doctype html><html class=h-full lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=deploy-date content="2022-08-04"><meta name=author content><meta name=color-scheme content="dark light"><style>@font-face{font-family:fira sans;font-style:normal;font-weight:400;font-display:swap;src:url(/fonts/fira-sans-v16-latin-regular.woff2)format('woff2')}@font-face{font-family:fira sans;font-style:normal;font-weight:600;font-display:swap;src:url(/fonts/fira-sans-v16-latin-600.woff2)format('woff2')}@font-face{font-family:merriweather;font-style:normal;font-weight:400;font-display:swap;src:url(/fonts/merriweather-v30-latin-regular.woff2)format('woff2')}@font-face{font-family:merriweather;font-style:normal;font-weight:700;font-display:swap;src:url(/fonts/merriweather-v30-latin-700.woff2)format('woff2')}</style><script async defer data-website-id=32b90065-c2a6-4390-9684-dfde99409815 src=https://umami-production-10b2.up.railway.app/main.js></script>
<script type=module defer src=https://phelipetls.github.io/js/bundle.min.js></script><meta name=description content="
    A blog to share my interests (mostly programming)
  "><meta name=publish-date content="2020-10-11"><meta name=last-modified-date content="2022-06-13"><meta name=keywords content="python,flask,heroku"><title>Deploying a Flask app on a Heroku free dyno |
Phelipe Teles</title><meta property="og:title" content="Deploying a Flask app on a Heroku free dyno"><meta property="og:description" content="The typical production-grade server used to deploy Python web apps, gunicorn, did not quite work for me. This post is the story of how I got it working."><meta property="og:type" content="article"><meta property="og:url" content="https://phelipetls.github.io/posts/deploying-flask-app-on-heroku/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-11T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-13T08:34:48-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploying a Flask app on a Heroku free dyno"><meta name=twitter:description content="The typical production-grade server used to deploy Python web apps, gunicorn, did not quite work for me. This post is the story of how I got it working."><link rel=stylesheet href="/css/main.min.css"><style>html{scroll-behavior:smooth}</style><link rel=stylesheet href=https://phelipetls.github.io/css/lite-yt-embed.min.css><link rel=stylesheet href=/css/dark-syntax-highlight.min.css></head><body data-preload class="h-full bg-background text-foreground transition-colors duration-500 ease-out"><script>(()=>{function a(e){localStorage.setItem("__theme",e)}function r(){return localStorage.getItem("__theme")||"auto"}function s(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function n(e){return e==="auto"?s():e}function o(e){const t=n(e);document.body.classList.toggle("dark",t==="dark")}function i(e){return new CustomEvent("newTheme",{detail:{themeChoice:e,theme:n(e)}})}function e(e){document.body.dispatchEvent(i(e))}window.__setTheme=function(t){if(!t)return;o(t),a(t),e(t)};var t=r();window.__setTheme(t),window.addEventListener("load",function(){document.body.removeAttribute("data-preload"),e(t)}),window.addEventListener("storage",function(e){const t=e.newValue;e.key==="__theme"&&window.__setTheme(t)})})()</script><div><div data-nav-container class="absolute top-0 z-0 h-nav-height w-full bg-background bg-opacity-95 py-2 backdrop-blur-sm backdrop-filter"><div class="mx-auto flex h-full max-w-5xl items-center justify-between pr-page-padding"><nav class="no-scrollbar flex h-full items-center overflow-x-scroll py-1 px-page-padding" aria-label="Main navigation"><ul class="m-0 flex h-full list-none flex-row flex-nowrap items-center gap-2"><li class=h-full><a id=home href=https://phelipetls.github.io/ class="after:content-[''] after:absolute after:-z-1 after:bg-surface
after:w-full after:h-full after:rounded-md after:shadow-md
after:shadow-shadow after:scale-0 hover:after:scale-100
after:opacity-0 hover:after:opacity-100
after:transition-[transform,_opacity] after:duration-500
hover:after:bg-hover
relative
flex
h-full
items-center
justify-center
rounded-md
border-0
px-2">Home</a></li><li class=h-full><a id=posts href=https://phelipetls.github.io/posts/ aria-current=page class="hover:bg-hover card transition-colors duration-500
relative
flex
h-full
items-center
justify-center
rounded-md
border-0
px-2">Posts</a></li><li class=h-full><a id=projects href=https://phelipetls.github.io/projects/ class="after:content-[''] after:absolute after:-z-1 after:bg-surface
after:w-full after:h-full after:rounded-md after:shadow-md
after:shadow-shadow after:scale-0 hover:after:scale-100
after:opacity-0 hover:after:opacity-100
after:transition-[transform,_opacity] after:duration-500
hover:after:bg-hover
relative
flex
h-full
items-center
justify-center
rounded-md
border-0
px-2">Projects</a></li><li class=h-full><a id=resume href=https://phelipetls.github.io/resume/ class="after:content-[''] after:absolute after:-z-1 after:bg-surface
after:w-full after:h-full after:rounded-md after:shadow-md
after:shadow-shadow after:scale-0 hover:after:scale-100
after:opacity-0 hover:after:opacity-100
after:transition-[transform,_opacity] after:duration-500
hover:after:bg-hover
relative
flex
h-full
items-center
justify-center
rounded-md
border-0
px-2">Résumé</a></li></ul></nav><div class="h-full py-1"><div class="card flex h-full items-center px-2"><button data-theme-button class="btn btn-icon" aria-label="Change theme" aria-expanded=false aria-controls=theme-listbox aria-haspopup=true><svg class="feather" viewBox="0 0 24 24"><title>Theme icon</title><defs><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><svg id="monitor" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></defs>
<use data-theme-button-svg-icon href=#sun></use></svg></button></div></div><ul data-theme-listbox id=theme-listbox class="card absolute top-0 left-0 z-50 m-0 flex list-none flex-col border border-divider text-lg" style=visibility:hidden;opacity:0;pointer-events:none;--icon-size:24px role=listbox aria-orientation=vertical aria-activedescendant=theme-option-auto aria-label="Theme options" tabindex=-1><li class="m-0 flex cursor-pointer items-center gap-1 px-2 py-1" id=theme-option-light data-theme=light role=option tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>Light</li><li class="m-0 flex cursor-pointer items-center gap-1 px-2 py-1" id=theme-option-dark data-theme=dark role=option tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>Dark</li><li class="m-0 flex cursor-pointer items-center gap-1 px-2 py-1" id=theme-option-auto data-theme=auto role=option tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>System</li></ul></div></div><main class="grid grid-cols-layout"><div class="col-full max-w-full rounded-none py-16 px-page-padding shadow-none sm:col-content sm:px-0"><article><header><h1 class="mb-4 text-4xl">Deploying a Flask app on a Heroku free dyno</h1><div class="mb-4 flex flex-col gap-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg><div>3 min.</div></div><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><time datetime=2020-10-11>October 11, 2020</time></div></div><div class="mb-4 flex flex-wrap gap-2"><a href=/tags/python/ class="tag whitespace-nowrap">python</a>
<a href=/tags/flask/ class="tag whitespace-nowrap">flask</a>
<a href=/tags/heroku/ class="tag whitespace-nowrap">heroku</a>
<a href=/tags class=tag aria-label="More tags">...</a></div></header><hr class=my-8><div class="flex flex-col-reverse lg:flex-row"><div data-blog-post class=max-w-prose><p>tl;dr: Use
<a href=https://docs.pylonsproject.org/projects/waitress/en/latest/>waitress</a>
instead
of <a href=https://gunicorn.org/>gunicorn</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gh>diff --git a/Procfile b/Procfile
</span></span></span><span class=line><span class=cl><span class=gh>index d49e1a0..0cd38da 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/Procfile
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/Procfile
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -1 +1 @@
</span></span></span><span class=line><span class=cl><span class=gu></span><span class=gd>-web: gunicorn &#34;app:create_app()&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+web: waitress-serve --port=$PORT --threads=${WEB_CONCURRENCY:-2} --call &#39;app:create_app&#39;
</span></span></span></code></pre></div><p>Recently, I had trouble deploying a Flask application using gunicorn as the WSGI
server on a Heroku&rsquo;s free dyno tier.</p><p>The problem boils down to the application not restarting when the dyno is
unidling, so once it sleeps it never wakes up again, unless you force it to do
so with <code>heroku restart</code>.</p><p>From the <code>heroku logs</code>:</p><pre><code>2020-08-27T19:21:21.060020+00:00 heroku[web.1]: State changed from down to starting
2020-08-27T19:21:26.527757+00:00 heroku[web.1]: Starting process with command `gunicorn &quot;app:create_app()&quot;`
2020-08-27T19:21:34.069516+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [4] [INFO] Starting gunicorn 20.0.4
2020-08-27T19:21:34.087317+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [4] [INFO] Listening at: http://0.0.0.0:3906 (4)
2020-08-27T19:21:34.092921+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [4] [INFO] Using worker: sync
2020-08-27T19:21:34.131957+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [10] [INFO] Booting worker with pid: 10
2020-08-27T19:21:34.201582+00:00 app[web.1]: [2020-08-27 19:21:34 +0000] [11] [INFO] Booting worker with pid: 11
2020-08-27T19:21:34.560508+00:00 heroku[web.1]: State changed from starting to up
2020-08-27T19:54:54.137845+00:00 heroku[web.1]: Idling
2020-08-27T19:54:54.139855+00:00 heroku[web.1]: State changed from up to down
2020-08-27T19:54:59.841651+00:00 heroku[web.1]: Stopping all processes with SIGTERM
2020-08-27T19:54:59.908237+00:00 app[web.1]: [2020-08-27 19:54:59 +0000] [11] [INFO] Worker exiting (pid: 11)
2020-08-27T19:54:59.910662+00:00 app[web.1]: [2020-08-27 19:54:59 +0000] [4] [INFO] Handling signal: term
2020-08-27T19:54:59.919059+00:00 app[web.1]: [2020-08-27 19:54:59 +0000] [10] [INFO] Worker exiting (pid: 10)
2020-08-27T19:55:00.122579+00:00 app[web.1]: [2020-08-27 19:55:00 +0000] [4] [INFO] Shutting down: Master
2020-08-27T19:55:00.223868+00:00 heroku[web.1]: Process exited with status 0
</code></pre><p>Every request would then be met with a Heroku <code>H10</code> error and 503 HTTP error.</p><p>I simply had this in my <code>Procfile</code>:</p><pre><code>web: gunicorn &quot;app:create_app()&quot;
</code></pre><p>I don&rsquo;t know if there&rsquo;s anything wrong with it or if I could have done something
to make it restart when unidling. Please let me know if that&rsquo;s the case.</p><p>By comparing with a node application log, the difference seems to be on how the
processes handle a <code>SIGTERM</code> signal. <code>node</code> exits with code 143 and restarts
just fine afterwards, but <code>gunicorn</code> exits with code 0 and doesn&rsquo;t restart
again.</p><p>I searched for a way to configure how gunicorn handles SIGTERM with no luck, but
that would be too awkward anyway.</p><p>Then I stumbled upon
<a href=https://blog.etianen.com/blog/2014/01/19/gunicorn-heroku-django/>a post discouraging the use of gunicorn on Heroku</a>
and recommending
<a href=https://docs.pylonsproject.org/projects/waitress/en/latest/>Waitress</a>
instead.</p><p>The mentioned blog post author&rsquo;s reasons are much more technical than mine, I
just wanted the application to not crash. So I changed the Procfile to:</p><pre><code>web: waitress-serve --port=$PORT --threads=${WEB_CONCURRENCY:-2} --call 'app:create_app'
</code></pre><p>As was suggested by the
<a href=https://flask.palletsprojects.com/en/1.1.x/tutorial/deploy/#run-with-a-production-server>Flask</a>
and
<a href=https://docs.pylonsproject.org/projects/waitress/en/latest/usage.html#heroku>Waitress documentation</a></p><p>Now the application restarts when unidling:</p><pre><code>2020-10-09T02:02:24.121855+00:00 heroku[web.1]: Idling
2020-10-09T02:02:24.123702+00:00 heroku[web.1]: State changed from up to down
2020-10-09T02:02:25.226026+00:00 heroku[web.1]: Stopping all processes with SIGTERM
2020-10-09T02:02:25.317332+00:00 heroku[web.1]: Process exited with status 143
2020-10-09T13:22:44.966887+00:00 heroku[web.1]: Unidling
2020-10-09T13:22:44.969344+00:00 heroku[web.1]: State changed from down to starting
2020-10-09T13:22:49.127433+00:00 heroku[web.1]: Starting process with command `waitress-serve --port=55574 --threads=${WEB_CONCURRENCY:-2} --call 'app:create_app'`
</code></pre></div><aside class=flex-1></aside></div></article><div data-theme-copy-code-tooltip role=tooltip class="pointer-events-none absolute rounded-md border border-divider bg-surface px-2" style=opacity:0>Copied<div data-theme-copy-code-tooltip-arrow class="absolute h-[8px] w-[8px] rotate-45 border-r border-b border-divider bg-surface"></div></div><hr class=my-8><div class="grid place-items-center"><script src=https://utteranc.es/client.js repo=phelipetls/phelipetls.github.io issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script></div><hr class=my-8><nav class="grid grid-cols-1 gap-2 sm:grid-cols-2" aria-label="Posts navigation"><a class="card flex h-full items-center gap-2 border-0 p-2 transition-colors duration-500 hover:bg-hover" href=/posts/vim-errorformat-for-pytest/><span class=text-primary><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></span>A Vim errorformat for pytest</a>
<a class="card flex h-full items-center justify-end gap-2 self-end border-0 p-2 text-right transition-colors duration-500 hover:bg-hover" href=/posts/f-strings-syntax-highlighting-in-vim/>Python f-strings syntax highlighting in Vim
<span class=text-primary><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span></a></nav></div></main><footer class="mx-auto flex w-full max-w-content flex-col gap-4 px-page-padding py-4 sm:flex-row sm:justify-between"><div class="flex flex-wrap justify-center sm:order-last sm:justify-end"><nav aria-label=Links><div class="flex gap-4"><a id=contact-email class=border-0 href=mailto:phelipe_teles@hotmail.com aria-label=E-mail><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a><a id=contact-linkedin class=border-0 href=https://linkedin.com/in/phelipeteles aria-label=LinkedIn><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a id=contact-github class=border-0 href=https://github.com/phelipetls aria-label=GitHub><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></nav></div><p class="flex-1 text-center sm:text-left">This content is under a
<a rel=license href=http://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0</a>
license.</p></footer></div><script src=https://phelipetls.github.io/js/post-bundle.min.js></script></body></html>