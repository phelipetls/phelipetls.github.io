<!DOCTYPE html><html class="h-full min-h-0 text-base sm:text-lg selection:bg-primary selection:text-on-primary scroll-smooth scroll-pt-nav-height sm:scroll-pt-0" lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="deploy-date" content="2023-10-14"><meta name="author" content="Phelipe Teles"><meta name="color-scheme" content="dark light"><title>Ergonomic mappings for code formatting in Vim - Phelipe Teles | Phelipe Teles</title><link rel="canonical" href="https://phelipetls.github.io/posts/code-formatting-vim/"><meta name="description" content="Vim allows you to format text with an arbitrary external program with the :h
gq operator. For example, say you want to format with prettier, you just
need to set :h 'formatprg' option to npx prettier --stdin-filepath %, and
gqip will format the paragraph with it (it also works if you select the text
first and then use gq — vipgq)."><meta name="robots" content="index, follow"><meta property="og:title" content="Ergonomic mappings for code formatting in Vim"><meta property="og:type" content="article"><meta property="og:image" content="/posts/code-formatting-vim/image.png"><meta property="og:url" content="https://phelipetls.github.io/posts/code-formatting-vim/"><meta property="article:published_time" content="2022-09-29T00:00:00Z"><meta property="article:author" content="Phelipe Teles"><meta property="article:tag" content="vim"><meta name="twitter:card" content="summary_large_image"><meta content="/posts/code-formatting-vim/image.png" name="twitter:image"><meta name="publish-date" content="2022-09-29"><meta name="keywords" content="vim"><meta name="description" content="Vim allows you to format text with an arbitrary external program with the :h
gq operator. For example, say you want to format with prettier, you just
need to set :h 'formatprg' option to npx prettier --stdin-filepath %, and
gqip will format the paragraph with it (it also works if you select the text
first and then use gq — vipgq)."><style id="sandpack">--sxs{--sxs:0 light sp-482805736}@media{.light{--sp-space-1:4px;--sp-space-2:8px;--sp-space-3:12px;--sp-space-4:16px;--sp-space-5:20px;--sp-space-6:24px;--sp-space-7:28px;--sp-space-8:32px;--sp-space-9:36px;--sp-space-10:40px;--sp-space-11:44px;--sp-border-radius:4px;--sp-layout-height:300px;--sp-layout-headerHeight:40px;--sp-transitions-default:150ms ease;--sp-zIndices-base:1;--sp-zIndices-overlay:2;--sp-zIndices-top:3;--sp-colors-surface1:#ffffff;--sp-colors-surface2:#EFEFEF;--sp-colors-surface3:#F3F3F3;--sp-colors-disabled:#C5C5C5;--sp-colors-base:#323232;--sp-colors-clickable:#808080;--sp-colors-hover:#4D4D4D;--sp-colors-accent:#3973E0;--sp-colors-error:#EA3323;--sp-colors-errorSurface:#FCF1F0;--sp-colors-warning:#6A4516;--sp-colors-warningSurface:#FEF2C0;--sp-font-body:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";--sp-font-mono:"Fira Mono", "DejaVu Sans Mono", Menlo, Consolas, "Liberation Mono", Monaco, "Lucida Console", monospace;--sp-font-size:13px;--sp-font-lineHeight:20px;--sp-syntax-color-plain:#151515;--sp-syntax-color-comment:#999;--sp-syntax-fontStyle-comment:italic;--sp-syntax-color-keyword:#7C5AE3;--sp-syntax-color-tag:#0971F1;--sp-syntax-color-punctuation:#3B3B3B;--sp-syntax-color-definition:#85A600;--sp-syntax-color-property:#3B3B3B;--sp-syntax-color-static:#3B3B3B;--sp-syntax-color-string:#2E6BD0}.sp-482805736{--sp-space-1:4px;--sp-space-2:8px;--sp-space-3:12px;--sp-space-4:16px;--sp-space-5:20px;--sp-space-6:24px;--sp-space-7:28px;--sp-space-8:32px;--sp-space-9:36px;--sp-space-10:40px;--sp-space-11:44px;--sp-border-radius:4px;--sp-layout-height:300px;--sp-layout-headerHeight:40px;--sp-transitions-default:150ms ease;--sp-zIndices-base:1;--sp-zIndices-overlay:2;--sp-zIndices-top:3;--sp-colors-surface1:#282c34;--sp-colors-surface2:#21252b;--sp-colors-surface3:#2c313c;--sp-colors-disabled:#4d4d4d;--sp-colors-base:#a8b1c2;--sp-colors-clickable:#a8b1c2;--sp-colors-hover:#e8effc;--sp-colors-accent:#c678dd;--sp-colors-error:#e06c75;--sp-colors-errorSurface:#ffeceb;--sp-colors-warning:#E7C400;--sp-colors-warningSurface:#3A3000;--sp-font-body:"Fira Sans", sans-serif;--sp-font-mono:Consolas, Menlo, Monaco, "Fira Code", monospace;--sp-font-size:1rem;--sp-font-lineHeight:1.5;--sp-syntax-color-plain:#a8b1c2;--sp-syntax-color-comment:#757575;--sp-syntax-fontStyle-comment:italic;--sp-syntax-color-keyword:#c678dd;--sp-syntax-color-tag:#e06c75;--sp-syntax-color-punctuation:#a8b1c2;--sp-syntax-color-definition:#62aeef;--sp-syntax-color-property:#d19a66;--sp-syntax-color-static:#a8b1c2;--sp-syntax-color-string:#98c379}}--sxs{--sxs:1 sp-k-eyOShd sp-k-iOHdLQ}@media{@keyframes sp-k-eyOShd{0%{opacity:0}100%{opacity:1}}@keyframes sp-k-iOHdLQ{0%{transform:rotateX(-25.5deg) rotateY(45deg)}100%{transform:rotateX(-25.5deg) rotateY(405deg)}}}--sxs{--sxs:2 sp-c-gMfcns sp-c-bxeRRt sp-c-hfoyCM sp-c-fWymNx sp-c-euXojQ sp-c-bpmgvy sp-c-PJLV sp-c-fVPbOs sp-c-gtcpyq sp-c-jOWzsE sp-c-jkvvao sp-c-juMdfR sp-c-fgviib sp-c-kwibBT}@media{.sp-c-gMfcns svg{margin:auto}.sp-c-bxeRRt{-webkit-appearance:none;appearance:none;outline:none;display:flex;align-items:center;font-size:inherit;font-family:inherit;background-color:transparent;transition:color var(--sp-transitions-default), background var(--sp-transitions-default);cursor:pointer;color:var(--sp-colors-clickable);border:0;text-decoration:none}.sp-c-bxeRRt:disabled{color:var(--sp-colors-disabled)}.sp-c-bxeRRt:hover:not(:disabled,[data-active='true']){color:var(--sp-colors-hover)}.sp-c-bxeRRt[data-active="true"]{color:var(--sp-colors-accent)}.sp-c-bxeRRt svg{min-width:var(--sp-space-4);width:var(--sp-space-4);height:var(--sp-space-4)}.sp-c-bxeRRt.sp-c-gMfcns{padding:var(--sp-space-1);height:var(--sp-space-7);display:flex}.sp-c-bxeRRt.sp-c-gMfcns.sp-c-bxeRRt:not(:has(span)){width:var(--sp-space-7)}.sp-c-bxeRRt.sp-c-gMfcns.sp-c-bxeRRt:has(svg + span){padding-right:var(--sp-space-3);padding-left:var(--sp-space-2);gap:var(--sp-space-1)}.sp-c-hfoyCM{padding:0 var(--sp-space-1) 0 var(--sp-space-1);border-radius:var(--sp-border-radius);margin-left:var(--sp-space-1);width:var(--sp-space-5);visibility:hidden}.sp-c-hfoyCM svg{width:var(--sp-space-3);height:var(--sp-space-3);display:block;position:relative;top:1px}.sp-c-fWymNx{margin:0;display:block;font-family:var(--sp-font-mono);font-size:var(--sp-font-size);color:var(--sp-syntax-color-plain);line-height:var(--sp-font-lineHeight)}.sp-c-euXojQ{display:flex;flex-direction:column;width:100%;position:relative;background-color:var(--sp-colors-surface1);gap:1px}.sp-c-euXojQ:has(.sp-stack){background-color:var(--sp-colors-surface2)}.sp-c-bpmgvy{transform:translate(-4px, 9px) scale(0.13, 0.13)}.sp-c-bpmgvy *{position:absolute;width:96px;height:96px}.sp-c-fVPbOs{all:initial;font-size:var(--sp-font-size);font-family:var(--sp-font-body);display:block;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:subpixel-antialiased}@media screen and (min-resolution: 2dppx){.sp-c-fVPbOs{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}.sp-c-fVPbOs *{box-sizing:border-box}.sp-c-fVPbOs .sp-wrapper:focus{outline:0}.sp-c-gtcpyq{flex:1;position:relative;overflow:auto;background:var(--sp-colors-surface1)}.sp-c-gtcpyq .cm-scroller{padding:var(--sp-space-4) 0}.sp-c-gtcpyq .sp-c-fWymNx{padding:var(--sp-space-4) 0}@media screen and (max-width: 768px){@supports (-webkit-overflow-scrolling: touch){.sp-c-gtcpyq .cm-content{font-size:16px}}}.sp-c-jOWzsE{margin:0;outline:none;height:100%}.sp-c-jkvvao .sp-syntax-string{color:var(--sp-syntax-color-string);font-style:var(--sp-syntax-fontStyle-string)}.sp-c-jkvvao .sp-syntax-plain{color:var(--sp-syntax-color-plain);font-style:var(--sp-syntax-fontStyle-plain)}.sp-c-jkvvao .sp-syntax-comment{color:var(--sp-syntax-color-comment);font-style:var(--sp-syntax-fontStyle-comment)}.sp-c-jkvvao .sp-syntax-keyword{color:var(--sp-syntax-color-keyword);font-style:var(--sp-syntax-fontStyle-keyword)}.sp-c-jkvvao .sp-syntax-definition{color:var(--sp-syntax-color-definition);font-style:var(--sp-syntax-fontStyle-definition)}.sp-c-jkvvao .sp-syntax-punctuation{color:var(--sp-syntax-color-punctuation);font-style:var(--sp-syntax-fontStyle-punctuation)}.sp-c-jkvvao .sp-syntax-property{color:var(--sp-syntax-color-property);font-style:var(--sp-syntax-fontStyle-property)}.sp-c-jkvvao .sp-syntax-tag{color:var(--sp-syntax-color-tag);font-style:var(--sp-syntax-fontStyle-tag)}.sp-c-jkvvao .sp-syntax-static{color:var(--sp-syntax-color-static);font-style:var(--sp-syntax-fontStyle-static)}.sp-c-juMdfR{flex:1;display:flex;flex-direction:column;background:white;overflow:auto;position:relative}.sp-c-juMdfR .sp-bridge-frame{border:0;position:absolute;left:var(--sp-space-2);bottom:var(--sp-space-2);z-index:var(--sp-zIndices-top);height:12px;width:30%;mix-blend-mode:multiply;pointer-events:none}.sp-c-fgviib{border:0;outline:0;width:100%;height:100%;min-height:160px;max-height:2000px;flex:1}.sp-c-kwibBT{display:flex;position:absolute;bottom:var(--sp-space-2);right:var(--sp-space-2);z-index:var(--sp-zIndices-overlay);gap:var(--sp-space-2)}}--sxs{--sxs:3 sp-c-PJLV-kCOVwI-status-pass sp-c-PJLV-kEzYsr-status-fail sp-c-PJLV-gHAhSA-status-skip sp-c-PJLV-jgnHyR-status-title sp-c-PJLV-iCgxLS-status-run sp-c-PJLV-bnDZSy-status-pass sp-c-PJLV-eYuGwt-status-fail sp-c-fVPbOs-gMQIch-variant-light sp-c-fVPbOs-LrWkf-variant-dark}@media{.sp-c-PJLV-kCOVwI-status-pass{color:var(--test-pass)}.sp-c-PJLV-kEzYsr-status-fail{color:var(--test-fail)}.sp-c-PJLV-gHAhSA-status-skip{color:var(--test-skip)}.sp-c-PJLV-jgnHyR-status-title{color:var(--test-title)}.sp-c-PJLV-iCgxLS-status-run{background:var(--test-run);color:var(--sp-colors-surface1)}.sp-c-PJLV-bnDZSy-status-pass{background:var(--test-pass);color:var(--sp-colors-surface1)}.sp-c-PJLV-eYuGwt-status-fail{background:var(--test-fail);color:var(--sp-colors-surface1)}.sp-c-fVPbOs-gMQIch-variant-light{color-scheme:light}.sp-c-fVPbOs-LrWkf-variant-dark{color-scheme:dark}}</style><link rel="stylesheet" href="/_astro/_id_.12b6fa55.css" />
<link rel="stylesheet" href="/_astro/_id_.f7b41e74.css" /><script type="module" src="/_astro/hoisted.12f342b6.js"></script></head><body data-preload class="relative flex h-full flex-col bg-background font-sans text-on-background"><script>
  // @ts-check
  const storedThemeChoice = window.localStorage.getItem('__theme') ?? 'system'

  window.__setTheme = setTheme
  // prettier-ignore
  window.__setTheme(/** @type {ThemeChoice} */ (storedThemeChoice))

  /**
   * @type {(themeChoice: ThemeChoice) => void}
   */
  function setTheme(themeChoice) {
    let theme = themeChoice

    if (themeChoice === 'system') {
      theme = window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light'
    }

    document.body.classList.toggle('dark', theme === 'dark')

    window.localStorage.setItem('__theme', themeChoice)

    document.body.dispatchEvent(
      new CustomEvent('newTheme', {
        detail: {
          themeChoice,
          theme,
        },
      })
    )
  }

  window.addEventListener('storage', function (e) {
    const newTheme = e.newValue
    if (newTheme && newTheme && e.key === '__theme') {
      // prettier-ignore
      window.__setTheme(/** @type {ThemeChoice} */ (newTheme))
    }
  })

  window.addEventListener('load', function () {
    document.querySelectorAll('[data-preload]').forEach((elem) => {
      elem.removeAttribute('data-preload')
    })
  })
</script><div class="w-full"><div class="pt-nav-height sm:hidden"><div class="fixed top-0 left-0 z-30 flex w-screen justify-between rounded-none border-b border-divider bg-background/90 py-4 px-horizontal-padding backdrop-blur"><div class="flex flex-row items-center gap-2"><a href="/posts/" data-testid="parent-page-link" aria-label="Go back to previous page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><polyline points="15 18 9 12 15 6"></polyline></svg></a><h2 class="m-0 truncate font-sans font-normal">Ergonomic mappings for code formatting in Vim - Phelipe Teles</h2></div><button type="button" class="hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 min-w-[40px] h-[40px] flex justify-center items-center rounded-full px-2 bg-transparent" data-a11y-dialog-show="sidenav" data-testid="open-sidenav" aria-label="Open navigation sidebar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg></button></div></div><div class="hidden h-full w-full sm:block"><div class="flex w-full items-center justify-between pr-horizontal-padding"><div class="mx-auto flex w-full max-w-content justify-between"><nav class="flex justify-between pl-horizontal-padding" aria-label="Main navigation"><ul class="m-0 flex flex-row list-none gap-2"><li><a id="about" href="/" class="p-2 inline-block h-full w-full group"><span class="underline underline-offset-8 decoration-2 decoration-transparent group-hover:decoration-hover">About</span></a></li><li><a id="posts" href="/posts" class="p-2 inline-block h-full w-full group" aria-current="page"><span class="underline underline-offset-8 decoration-2 decoration-primary group-hover:decoration-primary-hover">Posts</span></a></li></ul></nav><div class="flex flex-row items-center gap-2"><div style="--cols:3" class="rounded items-center grid grid-cols-[repeat(var(--cols),1fr)] bg-surface shadow-sm shadow-shadow"><select class="py-1 sm:py-0 rounded bg-inherit appearance-none text-center row-start-1 col-[1_/_calc(var(--cols)+1)] px-8" data-theme-select aria-label="Choose a theme"><option value="light">Light</option><option value="dark">Dark</option><option value="system">System</option></select><span class="pointer-events-none col-start-1 row-start-1 px-1 text-sm"><svg class="feather" viewBox="0 0 24 24" width="24" height="24"><title>Theme icon</title><defs><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon" id="moon"><path d="M12 3a6.364 6.364 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun" id="sun"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-monitor" id="monitor"><rect width="20" height="14" x="2" y="3" rx="2" ry="2"></rect><line x1="8" x2="16" y1="21" y2="21"></line><line x1="12" x2="12" y1="17" y2="21"></line></svg></defs><use data-theme-select-icon href="#monitor"></use></svg></span><span class="flex flex-row justify-end pointer-events-none text-sm row-start-1 px-1 col-[var(--cols)_/_var(--cols)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down" slot="end-icon"><polyline points="6 9 12 15 18 9"></polyline></svg></span></div></div></div></div></div></div><aside data-a11y-dialog="sidenav" aria-hidden="true" class="fixed z-50 h-full w-full" style="visibility: hidden;"><div data-a11y-dialog-hide class="fixed inset-0 -z-1 w-full bg-neutral-700 bg-opacity-75 backdrop-blur-sm"></div><div role="document" class="ml-auto h-full flex flex-col w-3/4 rounded-none bg-background py-0 will-change-transform"><div class="mb-2 flex h-nav-height items-center justify-end px-horizontal-padding"><button type="button" data-a11y-dialog-hide="true" aria-label="Close" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 min-w-[40px] h-[40px] flex justify-center items-center rounded-full px-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></svg></button></div><nav class="flex flex-col" aria-label="Main navigation"><ul class="m-0 flex list-none flex-col items-center justify-center gap-2 px-horizontal-padding"><li class="w-full"><a as="a" id="about" href="/" class="flex items-center justify-center flex-row gap-2 transition-colors duration-300 hover:bg-hover disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled rounded py-1 px-2 bg-surface text-on-background">About</a></li><li class="w-full"><a as="a" id="posts" href="/posts" aria-current="page" class="flex items-center justify-center flex-row gap-2 transition-colors duration-300 disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled rounded py-1 px-2 bg-primary text-on-primary hover:bg-primary-hover shadow-sm shadow-shadow">Posts</a></li></ul></nav><div class="flex flex-col gap-2 pb-4 mt-auto px-horizontal-padding [&_div]:flex-1"><div style="--cols:3" class="rounded items-center grid grid-cols-[repeat(var(--cols),1fr)] bg-background"><select class="py-1 sm:py-0 rounded bg-inherit appearance-none text-center row-start-1 col-[1_/_calc(var(--cols)+1)] px-8" data-language-select aria-label="Choose a language"><option selected="true" value="en">English</option><option value="pt">Português</option></select><span class="pointer-events-none col-start-1 row-start-1 px-1 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-languages" slot="start-icon"><path d="m5 8 6 6"></path><path d="m4 14 6-6 2-3"></path><path d="M2 5h12"></path><path d="M7 2h1"></path><path d="m22 22-5-10-5 10"></path><path d="M14 18h6"></path></svg></span><span class="flex flex-row justify-end pointer-events-none text-sm row-start-1 px-1 col-[var(--cols)_/_var(--cols)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down" slot="end-icon"><polyline points="6 9 12 15 18 9"></polyline></svg></span></div><div style="--cols:3" class="rounded items-center grid grid-cols-[repeat(var(--cols),1fr)] bg-surface shadow-sm shadow-shadow"><select class="py-1 sm:py-0 rounded bg-inherit appearance-none text-center row-start-1 col-[1_/_calc(var(--cols)+1)] px-8" data-theme-select aria-label="Choose a theme"><option value="light">Light</option><option value="dark">Dark</option><option value="system">System</option></select><span class="pointer-events-none col-start-1 row-start-1 px-1 text-sm"><svg class="feather" viewBox="0 0 24 24" width="24" height="24"><title>Theme icon</title><defs><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon" id="moon"><path d="M12 3a6.364 6.364 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun" id="sun"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-monitor" id="monitor"><rect width="20" height="14" x="2" y="3" rx="2" ry="2"></rect><line x1="8" x2="16" y1="21" y2="21"></line><line x1="12" x2="12" y1="17" y2="21"></line></svg></defs><use data-theme-select-icon href="#monitor"></use></svg></span><span class="flex flex-row justify-end pointer-events-none text-sm row-start-1 px-1 col-[var(--cols)_/_var(--cols)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down" slot="end-icon"><polyline points="6 9 12 15 18 9"></polyline></svg></span></div></div></div></aside><main class="grid grid-cols-layout"><div class="pt-8 sm:col-content px-0"><article><header class="flex flex-col"><h1 class="mb-4 text-4xl max-w-prose">Ergonomic mappings for code formatting in Vim</h1><div class="mb-4 flex gap-2 flex-row"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg><time datetime="2022-09-29">September 29</time></div><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-timer"><line x1="10" x2="14" y1="2" y2="2"></line><line x1="12" x2="15" y1="14" y2="11"></line><circle cx="12" cy="14" r="8"></circle></svg><div>3 min.</div></div></div><div class="mb-4 flex max-w-lg flex-wrap gap-2"><a class="inline-flex gap-2 w-fit items-center justify-center rounded-full border border-divider bg-surface px-4 no-underline shadow-sm shadow-shadow transition-colors duration-300 hover:border-divider hover:bg-hover whitespace-nowrap [&#38;_svg]:w-[1em] [&#38;_svg]:h-[1em] order-1" href="/tags/vim"><svg viewBox="0 0 128 128" width="1em" height="1em"><path fill="currentColor" d="M72.6 80.5c.2.2.6.5.9.5h5.3c.3 0 .7-.3.9-.5l1.4-1.5c.2-.2.3-.4.3-.6l1.5-5.1c.1-.5 0-1-.3-1.3l-1.1-.9c-.2-.2-.6-.1-.9-.1h-4.8l-.2-.2-.1-.1c-.2 0-.4-.1-.6.1L73 72c-.2 0-.3.5-.4.7L71 77.6c-.2.5-.1 1.1.3 1.5l1.3 1.4zm.8 26.4-.4.1h-1.2L79 85.9c.2-.7-.1-1.5-.8-1.7l-.4-.1H65.7c-.5.1-.9.5-1 1l-.7 2.5c-.2.7.3 1.3 1 1.5l.3-.1h1.8l-7.3 20.9c-.2.7.1 1.6.8 1.9l.4.3h11.2c.6 0 1.1-.5 1.3-1.1l.7-2.4c.3-.7-.1-1.5-.8-1.7zm53.1-19.7-1.9-2.5v-.1c-.3-.3-.6-.6-1-.6h-7.2c-.4 0-.7.4-1 .6l-2 2.4h-3.1l-2.1-2.4v-.1c-.2-.3-.6-.5-1-.5h-4l20.2-20.2-22.6-22.4L121 20.6v-9L118.2 8H77.3L74 11.5v2.9L62.7 3 55 10.5 52.6 8H12.2L9 11.7v9.4l3 2.9h3v26.1l-14 14 14 14v32l5.2 2.9h11.6l9.1-9.5 21.6 21.6L77 110.6c.1.4.4.5.9.7l.4-.2h9.4c.6 0 1.1-.1 1.2-.6l.7-2c.2-.7-.1-1.3-.8-1.5l-.4.1H88l3.4-10.7 2.3-2.3h5l-5 15.9c-.2.7.2 1.1.9 1.4l.4-.2h9.1c.5 0 1-.1 1.2-.6l.8-1.8c.3-.7-.1-1.3-.7-1.6-.1-.1-.3 0-.5 0h-.4l4.2-13h6.1l-5.1 15.9c-.2.7.2 1.1.9 1.3l.4-.3h10c.5 0 1-.1 1.2-.6l.8-2c.3-.7-.1-1.3-.8-1.5-.1-.1-.3.1-.5.1h-.7l5.6-18.5c.2-.5.1-1.1-.1-1.4zM62.7 4.9 74 16.2v4.7l3.4 4.1H79L50 53V25h3.3l2.7-4.2v-8.9l-.2-.3 6.9-6.7zM2.9 64.1 15 52v24.2L2.9 64.1zm38.9 38.3 58.4-60 21.4 21.5-20.2 20.2h-.1c-.3.1-.5.3-.7.5L98.5 87h-2.9l-2.2-2.4c-.2-.3-.6-.6-1-.6h-8.8c-.6 0-1.1.4-1.3 1l-.8 2.5c-.2.7.1 1.3.8 1.6h1.5L77.4 108l-15.1 15.2-20.5-20.8z"></path></svg>vim</a><a class="inline-flex gap-2 w-fit items-center justify-center rounded-full border border-divider bg-surface px-4 no-underline shadow-sm shadow-shadow transition-colors duration-300 hover:border-divider hover:bg-hover whitespace-nowrap [&#38;_svg]:w-[1em] [&#38;_svg]:h-[1em] order-2" href="/tags">...</a></div></header><hr class="my-8"><div data-blog-post-container data-toc="open" class="group flex flex-col lg:gap-8 lg:flex-row-reverse"><aside style="--offset-from-top:1rem" class="relative mb-8 lg:ml-auto lg:mb-0 lg:basis-1/3 lg:sticky lg:top-[var(--offset-from-top)] lg:h-[calc(100vh-var(--offset-from-top)_*_2)]"><button type="button" data-toggle-toc="true" data-open-toc-label="Open table of contents" data-closed-toc-label="Close table of contents" aria-label="Close table of contents" style="--duration:150ms" data-preload="true" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary min-w-[40px] h-[40px] justify-center items-center rounded-full px-2 z-1 absolute top-4 right-4 hidden lg:grid lg:min-w-0 lg:group-data-toc-open:grid-cols-[0fr_max-content] lg:group-data-toc-closed:grid-cols-[1fr_max-content] transition-all duration-[var(--duration)] ease-in-out overflow-hidden lg:justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="col-start-2 col-end-2 row-start-1 row-end-1 scale-0 transition-transform duration-[var(--duration)] ease-out group-data-toc-open:scale-100 group-data-toc-open:delay-[var(--duration)]"><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="col-start-2 col-end-2 row-start-1 row-end-1 scale-0 transition-transform duration-[var(--duration)] ease-in group-data-toc-closed:scale-100 group-data-toc-closed:delay-[var(--duration)"><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></svg><div class="col-start-1 col-end-1 group-data-toc-closed:mx-2 truncate">Open table of contents</div></button><div data-blog-post-toc-container data-preload class="max-sm:card lg:h-full lg:p-4 lg:ml-auto lg:group-data-toc-open:translate-x-0 lg:group-data-toc-open:scale-x-1 lg:group-data-toc-open:opacity-1 lg:group-data-toc-closed:translate-x-full lg:group-data-toc-closed:opacity-0 lg:group-data-toc-closed:scale-x-0 lg:group-data-toc-closed:pointer-events-none transition-[transform,opacity] duration-300 ease-in-out"><div class="hidden lg:flex lg:h-full lg:flex-col"><div class="flex items-center gap-2 h-10 flex-none"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list"><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></svg><h2 class="m-0">Table of Contents</h2><div class="ml-auto flex items-center transition-transform duration-150 ease-in group-open:rotate-180 lg:hidden"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg></div></div><nav data-toc-wrapper class="pt-4 h-full min-h-0 lg:overflow-y-auto [&#38;_a_*]:indent-0 [&#38;_ol]:m-0 [&#38;_ol]:list-none [&#38;_ol]:indent-4 [&#38;_ol_li[data-active]>a]:text-primary [&#38;_ol_li[data-active]]:before:bg-primary [&#38;_ol_li]:relative [&#38;_ol_li]:before:absolute [&#38;_ol_li]:before:left-0 [&#38;_ol_li]:before:top-0 [&#38;_ol_li]:before:h-full [&#38;_ol_li]:before:w-[1px] [&#38;_ol_li]:before:bg-divider [&#38;_ol_li]:before:content-[''] [&#38;_ol_li_a:hover]:bg-hover [&#38;_ol_li_a]:block [&#38;_ol_li_a]:truncate [&#38;_ol_li_a]:border-b-0 [&#38;_ol_li_a]:transition-colors [&#38;_ol_li_a]:duration-300 [&#38;_ol_ol]:indent-8 [&#38;_ol_ol_ol]:indent-12 [&#38;_ol_ol_ol_ol]:indent-16"><ol data-astro-toc="1"><li data-astro-toc="1"><a href="#how-to-customize-gq">How to customize gq</a></li><li data-astro-toc="1"><a href="#avoid-changing-the-jumplist">Avoid changing the jumplist</a></li><li data-astro-toc="1"><a href="#silent-execution">Silent execution</a></li><li data-astro-toc="1"><a href="#error-handling">Error handling</a></li><li data-astro-toc="1"><a href="#format-file-preserving-cursor-position">Format file preserving cursor position</a></li><li data-astro-toc="1"><a href="#integration-with-cocnvim">Integration with coc.nvim</a></li></ol></nav></div><details class="group px-horizontal-padding py-4 lg:hidden" aria-label="Table of Contents"><summary class="list-none"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list"><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></svg><h2 class="m-0">Table of Contents</h2><div class="flex items-center ml-auto transition-transform duration-150 ease-in group-open:rotate-180 lg:hidden"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg></div></div></summary><nav data-toc-wrapper class="mt-4 [&#38;_ol]:m-0 [&#38;_ol]:list-outside [&#38;_ol]:px-horizontal-padding [&#38;_ol_li:not(:first-child)]:mt-1"><ol data-astro-toc="1"><li data-astro-toc="1"><a href="#how-to-customize-gq">How to customize gq</a></li><li data-astro-toc="1"><a href="#avoid-changing-the-jumplist">Avoid changing the jumplist</a></li><li data-astro-toc="1"><a href="#silent-execution">Silent execution</a></li><li data-astro-toc="1"><a href="#error-handling">Error handling</a></li><li data-astro-toc="1"><a href="#format-file-preserving-cursor-position">Format file preserving cursor position</a></li><li data-astro-toc="1"><a href="#integration-with-cocnvim">Integration with coc.nvim</a></li></ol></nav></details></div></aside><div data-blog-post class="w-full max-w-prose [&#38;>pre]:my-8 [&#38;>pre]:max-sm:full-bleed [&#38;>[data-codeblock]]:my-8 [&#38;>[data-codeblock]]:max-sm:full-bleed [&#38;>[data-codeblock]_pre]:max-sm:rounded-none [&#38;>[data-codeblock]_[data-codeblock-header]]:max-sm:rounded-none [&#38;>img]:my-8 [&#38;_img]:mx-auto [&#38;>hr]:border-0 [&#38;>hr]:text-center [&#38;>hr]:after:content-['⁂'] [&#38;>figure]:my-8 [&#38;>figure]:max-sm:full-bleed [&#38;>astro-island>div]:my-8 [&#38;>lite-youtube]:my-8 [&#38;>blockquote]:my-8 [&#38;>figure_video]:min-h-[15em] [&#38;_.katex-display]:overflow-x-auto [&#38;_.katex-display]:overflow-y-hidden"><p>Vim allows you to format text with an arbitrary external program with the <code>:h gq</code> operator. For example, say you want to format with <code>prettier</code>, you just
need to set <code>:h &#39;formatprg&#39;</code> option to <code>npx prettier --stdin-filepath %</code>, and
<code>gqip</code> will format the paragraph with it (it also works if you select the text
first and then use <code>gq</code> — <code>vipgq</code>).</p>
<p>While this feature is great as is, it’s still lacking</p>
<h2 id="how-to-customize-gq" class="mb-8 mt-4 pt-4 [&#38;_a]:text-primary [&#38;_a]:border-0 [&#38;_a]:before:content-['#'] [&#38;_a]:before:text-xl [&#38;_a]:before:ml-2">How to customize <code>gq</code><a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" aria-hidden="true" tabindex="-1" href="#how-to-customize-gq"><span class="icon icon-link"></span></a></h2>
<p>We can customize <code>gq</code> by remapping it to use the <code>g@</code> operator instead, which
will run whatever function you pass to the <code>:h &#39;operatorfunc&#39;</code> option. See <code>:h :map-operator</code> for more information.</p>
<div data-codeblock class="last:mb-0" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div data-codeblock-header class="dark flex items-center gap-2 rounded-t py-1 bg-[var(--code-bg)] text-[var(--code-fg)] border-b border-divider" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div class="flex pl-2 items-center gap-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><svg viewBox="0 0 128 128" width="1em" height="1em"><path fill="currentColor" d="M72.6 80.5c.2.2.6.5.9.5h5.3c.3 0 .7-.3.9-.5l1.4-1.5c.2-.2.3-.4.3-.6l1.5-5.1c.1-.5 0-1-.3-1.3l-1.1-.9c-.2-.2-.6-.1-.9-.1h-4.8l-.2-.2-.1-.1c-.2 0-.4-.1-.6.1L73 72c-.2 0-.3.5-.4.7L71 77.6c-.2.5-.1 1.1.3 1.5l1.3 1.4zm.8 26.4-.4.1h-1.2L79 85.9c.2-.7-.1-1.5-.8-1.7l-.4-.1H65.7c-.5.1-.9.5-1 1l-.7 2.5c-.2.7.3 1.3 1 1.5l.3-.1h1.8l-7.3 20.9c-.2.7.1 1.6.8 1.9l.4.3h11.2c.6 0 1.1-.5 1.3-1.1l.7-2.4c.3-.7-.1-1.5-.8-1.7zm53.1-19.7-1.9-2.5v-.1c-.3-.3-.6-.6-1-.6h-7.2c-.4 0-.7.4-1 .6l-2 2.4h-3.1l-2.1-2.4v-.1c-.2-.3-.6-.5-1-.5h-4l20.2-20.2-22.6-22.4L121 20.6v-9L118.2 8H77.3L74 11.5v2.9L62.7 3 55 10.5 52.6 8H12.2L9 11.7v9.4l3 2.9h3v26.1l-14 14 14 14v32l5.2 2.9h11.6l9.1-9.5 21.6 21.6L77 110.6c.1.4.4.5.9.7l.4-.2h9.4c.6 0 1.1-.1 1.2-.6l.7-2c.2-.7-.1-1.3-.8-1.5l-.4.1H88l3.4-10.7 2.3-2.3h5l-5 15.9c-.2.7.2 1.1.9 1.4l.4-.2h9.1c.5 0 1-.1 1.2-.6l.8-1.8c.3-.7-.1-1.3-.7-1.6-.1-.1-.3 0-.5 0h-.4l4.2-13h6.1l-5.1 15.9c-.2.7.2 1.1.9 1.3l.4-.3h10c.5 0 1-.1 1.2-.6l.8-2c.3-.7-.1-1.3-.8-1.5-.1-.1-.3.1-.5.1h-.7l5.6-18.5c.2-.5.1-1.1-.1-1.4zM62.7 4.9 74 16.2v4.7l3.4 4.1H79L50 53V25h3.3l2.7-4.2v-8.9l-.2-.3 6.9-6.7zM2.9 64.1 15 52v24.2L2.9 64.1zm38.9 38.3 58.4-60 21.4 21.5-20.2 20.2h-.1c-.3.1-.5.3-.7.5L98.5 87h-2.9l-2.2-2.4c-.2-.3-.6-.6-1-.6h-8.8c-.6 0-1.1.4-1.3 1l-.8 2.5c-.2.7.1 1.3.8 1.6h1.5L77.4 108l-15.1 15.2-20.5-20.8z"></path></svg><div class="rtl truncate font-mono" style="--code-bg: #282c34;--code-fg: #abb2bf;">vim</div></div><div class="ml-auto flex flex-row gap-2 [&_svg]:h-6 [&_svg]:w-6 pr-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var b=Object.defineProperty;var f=(c,o,i)=>o in c?b(c,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[o]=i;var l=(c,o,i)=>(f(c,typeof o!="symbol"?o+"":o,i),i);var p;{let c={0:t=>m(t),1:t=>i(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(i(t)),5:t=>new Set(i(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[e,r]=t;return e in c?c[e](r):void 0},i=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,r])=>[e,o(r)]));customElements.get("astro-island")||customElements.define("astro-island",(p=class extends HTMLElement{constructor(){super(...arguments);l(this,"Component");l(this,"hydrator");l(this,"hydrate",async()=>{var d;if(!this.hydrator||!this.isConnected)return;let e=(d=this.parentElement)==null?void 0:d.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let r=this.querySelectorAll("astro-slot"),a={},h=this.querySelectorAll("template[data-astro-template]");for(let n of h){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("data-astro-template")||"default"]=n.innerHTML,n.remove())}for(let n of r){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("name")||"default"]=n.innerHTML)}let u;try{u=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(n){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),n),n}await this.hydrator(this)(this.Component,u,a,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});l(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),r.disconnect(),this.childrenConnectedCallback()},r=new MutationObserver(()=>{var a;((a=this.lastChild)==null?void 0:a.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});r.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),r=this.getAttribute("client");if(Astro[r]===void 0){window.addEventListener(`astro:${r}`,()=>this.start(),{once:!0});return}Astro[r](async()=>{let a=this.getAttribute("renderer-url"),[h,{default:u}]=await Promise.all([import(this.getAttribute("component-url")),a?import(a):()=>()=>{}]),d=this.getAttribute("component-export")||"default";if(!d.includes("."))this.Component=h[d];else{this.Component=h;for(let n of d.split("."))this.Component=this.Component[n]}return this.hydrator=u,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},l(p,"observedAttributes",["props"]),p))}})();</script><astro-island uid="VIByS" prefix="r36" component-url="/_astro/CopyCodeBlockButton.c533e2fc.js" component-export="default" renderer-url="/_astro/client.74da55d9.js" props="{&quot;successText&quot;:[0,&quot;Copied!&quot;],&quot;errorText&quot;:[0,&quot;Failed to copy&quot;],&quot;code&quot;:[0,&quot;function! s:Format(...)\n  \&quot; Some logic here to do the formatting\nendfunction\n\nnmap &lt;silent&gt; gq :set operatorfunc=&lt;SID&gt;Format&lt;CR&gt;g@\nvmap &lt;silent&gt; gq :&lt;C-U&gt;set operatorfunc=&lt;SID&gt;Format&lt;CR&gt;gvg@\n&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;CopyCodeBlockButton&quot;,&quot;value&quot;:true}" await-children=""><button type="button" aria-label="Copy code" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 rounded border border-divider p-1 shadow-sm shadow-shadow"><span class="text-[var(--code-fg)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg></span></button><!--astro:end--></astro-island></div></div><pre class="shiki shadow-sm shadow-shadow rounded-b overflow-x-auto bg-[var(--code-bg)] text-[var(--code-fg)] [color-scheme:dark] [&#38;_code]:py-4 [&#38;_code]:grid [&#38;_code>.line]:px-8 [&#38;_code>.line]:border-l-[2px] [&#38;_code>.line]:border-[var(--code-bg)] [&#38;_code>.line.highlight]:bg-[#272115] [&#38;_code>.line.highlight]:border-[#624710] [&#38;_.error]:text-sm [&#38;_.error]:px-8 [&#38;_.error]:py-1 [&#38;_.popover]:my-2 [&#38;_.popover]:rounded-sm [&#38;_.popover]:bg-gray-700 [&#38;_.popover]:text-white [&#38;_.arrow]:bg-gray-700 [&#38;_.arrow]:border-gray-700" style="--code-bg: #282c34;--code-fg: #abb2bf;"><code class="language-vim"><span class="line"><span style="color:#C678DD">function</span><span style="color:#ABB2BF">! </span><span style="color:#61AFEF">s:Format</span><span style="color:#ABB2BF">(...)</span></span><span class="line"><span style="color:#7F848E">  &quot; Some logic here to do the formatting</span></span><span class="line"><span style="color:#C678DD">endfunction</span></span><span class="line"><span> </span></span><span class="line"><span style="color:#C678DD">nmap</span><span style="color:#ABB2BF"> &lt;</span><span style="color:#D19A66">silent</span><span style="color:#ABB2BF">&gt; gq :</span><span style="color:#C678DD">set</span><span style="color:#ABB2BF"> operatorfunc=&lt;</span><span style="color:#D19A66">SID</span><span style="color:#ABB2BF">&gt;Format&lt;</span><span style="color:#D19A66">CR</span><span style="color:#ABB2BF">&gt;g@</span></span><span class="line"><span style="color:#C678DD">vmap</span><span style="color:#ABB2BF"> &lt;</span><span style="color:#D19A66">silent</span><span style="color:#ABB2BF">&gt; gq :&lt;</span><span style="color:#D19A66">C-U</span><span style="color:#ABB2BF">&gt;</span><span style="color:#C678DD">set</span><span style="color:#ABB2BF"> operatorfunc=&lt;</span><span style="color:#D19A66">SID</span><span style="color:#ABB2BF">&gt;Format&lt;</span><span style="color:#D19A66">CR</span><span style="color:#ABB2BF">&gt;gvg@</span></span></code></pre></div>
<p>Now our job will consist of writing what the <code>s:Format</code> function does.</p>
<p>The most innocuous implementation is to simply execute the <code>gq</code> behavior,
unchanged:</p>
<div data-codeblock class="last:mb-0" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div data-codeblock-header class="dark flex items-center gap-2 rounded-t py-1 bg-[var(--code-bg)] text-[var(--code-fg)] border-b border-divider" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div class="flex pl-2 items-center gap-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><svg viewBox="0 0 128 128" width="1em" height="1em"><path fill="currentColor" d="M72.6 80.5c.2.2.6.5.9.5h5.3c.3 0 .7-.3.9-.5l1.4-1.5c.2-.2.3-.4.3-.6l1.5-5.1c.1-.5 0-1-.3-1.3l-1.1-.9c-.2-.2-.6-.1-.9-.1h-4.8l-.2-.2-.1-.1c-.2 0-.4-.1-.6.1L73 72c-.2 0-.3.5-.4.7L71 77.6c-.2.5-.1 1.1.3 1.5l1.3 1.4zm.8 26.4-.4.1h-1.2L79 85.9c.2-.7-.1-1.5-.8-1.7l-.4-.1H65.7c-.5.1-.9.5-1 1l-.7 2.5c-.2.7.3 1.3 1 1.5l.3-.1h1.8l-7.3 20.9c-.2.7.1 1.6.8 1.9l.4.3h11.2c.6 0 1.1-.5 1.3-1.1l.7-2.4c.3-.7-.1-1.5-.8-1.7zm53.1-19.7-1.9-2.5v-.1c-.3-.3-.6-.6-1-.6h-7.2c-.4 0-.7.4-1 .6l-2 2.4h-3.1l-2.1-2.4v-.1c-.2-.3-.6-.5-1-.5h-4l20.2-20.2-22.6-22.4L121 20.6v-9L118.2 8H77.3L74 11.5v2.9L62.7 3 55 10.5 52.6 8H12.2L9 11.7v9.4l3 2.9h3v26.1l-14 14 14 14v32l5.2 2.9h11.6l9.1-9.5 21.6 21.6L77 110.6c.1.4.4.5.9.7l.4-.2h9.4c.6 0 1.1-.1 1.2-.6l.7-2c.2-.7-.1-1.3-.8-1.5l-.4.1H88l3.4-10.7 2.3-2.3h5l-5 15.9c-.2.7.2 1.1.9 1.4l.4-.2h9.1c.5 0 1-.1 1.2-.6l.8-1.8c.3-.7-.1-1.3-.7-1.6-.1-.1-.3 0-.5 0h-.4l4.2-13h6.1l-5.1 15.9c-.2.7.2 1.1.9 1.3l.4-.3h10c.5 0 1-.1 1.2-.6l.8-2c.3-.7-.1-1.3-.8-1.5-.1-.1-.3.1-.5.1h-.7l5.6-18.5c.2-.5.1-1.1-.1-1.4zM62.7 4.9 74 16.2v4.7l3.4 4.1H79L50 53V25h3.3l2.7-4.2v-8.9l-.2-.3 6.9-6.7zM2.9 64.1 15 52v24.2L2.9 64.1zm38.9 38.3 58.4-60 21.4 21.5-20.2 20.2h-.1c-.3.1-.5.3-.7.5L98.5 87h-2.9l-2.2-2.4c-.2-.3-.6-.6-1-.6h-8.8c-.6 0-1.1.4-1.3 1l-.8 2.5c-.2.7.1 1.3.8 1.6h1.5L77.4 108l-15.1 15.2-20.5-20.8z"></path></svg><div class="rtl truncate font-mono" style="--code-bg: #282c34;--code-fg: #abb2bf;">vim</div></div><div class="ml-auto flex flex-row gap-2 [&_svg]:h-6 [&_svg]:w-6 pr-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><astro-island uid="Z1ccQ3I" prefix="r37" component-url="/_astro/CopyCodeBlockButton.c533e2fc.js" component-export="default" renderer-url="/_astro/client.74da55d9.js" props="{&quot;successText&quot;:[0,&quot;Copied!&quot;],&quot;errorText&quot;:[0,&quot;Failed to copy&quot;],&quot;code&quot;:[0,&quot;function! s:Format(...)\n  normal! &#39;[v&#39;]gq\nendfunction\n&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;CopyCodeBlockButton&quot;,&quot;value&quot;:true}" await-children=""><button type="button" aria-label="Copy code" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 rounded border border-divider p-1 shadow-sm shadow-shadow"><span class="text-[var(--code-fg)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg></span></button><!--astro:end--></astro-island></div></div><pre class="shiki shadow-sm shadow-shadow rounded-b overflow-x-auto bg-[var(--code-bg)] text-[var(--code-fg)] [color-scheme:dark] [&#38;_code]:py-4 [&#38;_code]:grid [&#38;_code>.line]:px-8 [&#38;_code>.line]:border-l-[2px] [&#38;_code>.line]:border-[var(--code-bg)] [&#38;_code>.line.highlight]:bg-[#272115] [&#38;_code>.line.highlight]:border-[#624710] [&#38;_.error]:text-sm [&#38;_.error]:px-8 [&#38;_.error]:py-1 [&#38;_.popover]:my-2 [&#38;_.popover]:rounded-sm [&#38;_.popover]:bg-gray-700 [&#38;_.popover]:text-white [&#38;_.arrow]:bg-gray-700 [&#38;_.arrow]:border-gray-700" style="--code-bg: #282c34;--code-fg: #abb2bf;"><code class="language-vim"><span class="line"><span style="color:#C678DD">function</span><span style="color:#ABB2BF">! </span><span style="color:#61AFEF">s:Format</span><span style="color:#ABB2BF">(...)</span></span><span class="line"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">normal</span><span style="color:#ABB2BF">! </span><span style="color:#98C379">&#39;[v&#39;</span><span style="color:#ABB2BF">]gq</span></span><span class="line"><span style="color:#C678DD">endfunction</span></span></code></pre></div>
<aside class="my-8 flex gap-4 sm:rounded border-y sm:border-y-0 sm:border-l bg-surface max-sm:full-bleed px-horizontal-padding py-4 sm:shadow-sm sm:shadow-shadow sm:mx-0 flex-row border-note"><div class=""><div class="text-note"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="16" y2="12"></line><line x1="12" x2="12.01" y1="8" y2="8"></line></svg></div></div><article class="overflow-x-hidden max-w-prose [&_h2]:first-of-type:mt-0 [&_h2]:first-of-type:pt-0"><p>We can programmatically run normal mode commands with <code>normal</code>. The <code>!</code> is
necessary to run the original <code>gq</code> functionality (as if it was never remapped),
otherwise this would result in an infinite recursion, calling <code>s:Format</code>
function over and over.</p><p>The <code>&#39;[v&#39;]</code> will select the text moved over by the <code>g@</code> operator (the text you
selected or moved over with <code>gqip</code>, see <code>:h mark-motions</code>), and then apply the
original <code>gq</code> operator into it.</p></article></aside>
<p>Of course, this is pointless, so let’s add to that function to enhance our
experience:</p>
<h2 id="avoid-changing-the-jumplist" class="mb-8 mt-4 pt-4 [&#38;_a]:text-primary [&#38;_a]:border-0 [&#38;_a]:before:content-['#'] [&#38;_a]:before:text-xl [&#38;_a]:before:ml-2">Avoid changing the jumplist<a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" aria-hidden="true" tabindex="-1" href="#avoid-changing-the-jumplist"><span class="icon icon-link"></span></a></h2>
<p>The first small tweak is to avoid changing the jumplist when we format text,
which we do by prefixing the command with <code>:h :keepjumps</code>.</p>
<div data-codeblock class="last:mb-0" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div data-codeblock-header class="dark flex items-center gap-2 rounded-t py-1 bg-[var(--code-bg)] text-[var(--code-fg)] border-b border-divider" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div class="flex pl-2 items-center gap-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><svg viewBox="0 0 128 128" width="1em" height="1em"><path fill="currentColor" d="M72.6 80.5c.2.2.6.5.9.5h5.3c.3 0 .7-.3.9-.5l1.4-1.5c.2-.2.3-.4.3-.6l1.5-5.1c.1-.5 0-1-.3-1.3l-1.1-.9c-.2-.2-.6-.1-.9-.1h-4.8l-.2-.2-.1-.1c-.2 0-.4-.1-.6.1L73 72c-.2 0-.3.5-.4.7L71 77.6c-.2.5-.1 1.1.3 1.5l1.3 1.4zm.8 26.4-.4.1h-1.2L79 85.9c.2-.7-.1-1.5-.8-1.7l-.4-.1H65.7c-.5.1-.9.5-1 1l-.7 2.5c-.2.7.3 1.3 1 1.5l.3-.1h1.8l-7.3 20.9c-.2.7.1 1.6.8 1.9l.4.3h11.2c.6 0 1.1-.5 1.3-1.1l.7-2.4c.3-.7-.1-1.5-.8-1.7zm53.1-19.7-1.9-2.5v-.1c-.3-.3-.6-.6-1-.6h-7.2c-.4 0-.7.4-1 .6l-2 2.4h-3.1l-2.1-2.4v-.1c-.2-.3-.6-.5-1-.5h-4l20.2-20.2-22.6-22.4L121 20.6v-9L118.2 8H77.3L74 11.5v2.9L62.7 3 55 10.5 52.6 8H12.2L9 11.7v9.4l3 2.9h3v26.1l-14 14 14 14v32l5.2 2.9h11.6l9.1-9.5 21.6 21.6L77 110.6c.1.4.4.5.9.7l.4-.2h9.4c.6 0 1.1-.1 1.2-.6l.7-2c.2-.7-.1-1.3-.8-1.5l-.4.1H88l3.4-10.7 2.3-2.3h5l-5 15.9c-.2.7.2 1.1.9 1.4l.4-.2h9.1c.5 0 1-.1 1.2-.6l.8-1.8c.3-.7-.1-1.3-.7-1.6-.1-.1-.3 0-.5 0h-.4l4.2-13h6.1l-5.1 15.9c-.2.7.2 1.1.9 1.3l.4-.3h10c.5 0 1-.1 1.2-.6l.8-2c.3-.7-.1-1.3-.8-1.5-.1-.1-.3.1-.5.1h-.7l5.6-18.5c.2-.5.1-1.1-.1-1.4zM62.7 4.9 74 16.2v4.7l3.4 4.1H79L50 53V25h3.3l2.7-4.2v-8.9l-.2-.3 6.9-6.7zM2.9 64.1 15 52v24.2L2.9 64.1zm38.9 38.3 58.4-60 21.4 21.5-20.2 20.2h-.1c-.3.1-.5.3-.7.5L98.5 87h-2.9l-2.2-2.4c-.2-.3-.6-.6-1-.6h-8.8c-.6 0-1.1.4-1.3 1l-.8 2.5c-.2.7.1 1.3.8 1.6h1.5L77.4 108l-15.1 15.2-20.5-20.8z"></path></svg><div class="rtl truncate font-mono" style="--code-bg: #282c34;--code-fg: #abb2bf;">vim</div></div><div class="ml-auto flex flex-row gap-2 [&_svg]:h-6 [&_svg]:w-6 pr-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><astro-island uid="13U3EV" prefix="r38" component-url="/_astro/CopyCodeBlockButton.c533e2fc.js" component-export="default" renderer-url="/_astro/client.74da55d9.js" props="{&quot;successText&quot;:[0,&quot;Copied!&quot;],&quot;errorText&quot;:[0,&quot;Failed to copy&quot;],&quot;code&quot;:[0,&quot;function! s:Format(...)\n  keepjumps normal! &#39;[v&#39;]gq\nendfunction\n&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;CopyCodeBlockButton&quot;,&quot;value&quot;:true}" await-children=""><button type="button" aria-label="Copy code" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 rounded border border-divider p-1 shadow-sm shadow-shadow"><span class="text-[var(--code-fg)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg></span></button><!--astro:end--></astro-island></div></div><pre class="shiki shadow-sm shadow-shadow rounded-b overflow-x-auto bg-[var(--code-bg)] text-[var(--code-fg)] [color-scheme:dark] [&#38;_code]:py-4 [&#38;_code]:grid [&#38;_code>.line]:px-8 [&#38;_code>.line]:border-l-[2px] [&#38;_code>.line]:border-[var(--code-bg)] [&#38;_code>.line.highlight]:bg-[#272115] [&#38;_code>.line.highlight]:border-[#624710] [&#38;_.error]:text-sm [&#38;_.error]:px-8 [&#38;_.error]:py-1 [&#38;_.popover]:my-2 [&#38;_.popover]:rounded-sm [&#38;_.popover]:bg-gray-700 [&#38;_.popover]:text-white [&#38;_.arrow]:bg-gray-700 [&#38;_.arrow]:border-gray-700" style="--code-bg: #282c34;--code-fg: #abb2bf;"><code class="language-vim" metastring="{2}"><span class="line"><span style="color:#C678DD">function</span><span style="color:#ABB2BF">! </span><span style="color:#61AFEF">s:Format</span><span style="color:#ABB2BF">(...)</span></span><span class="line highlight"><span style="color:#ABB2BF">  keepjumps </span><span style="color:#C678DD">normal</span><span style="color:#ABB2BF">! </span><span style="color:#98C379">&#39;[v&#39;</span><span style="color:#ABB2BF">]gq</span></span><span class="line"><span style="color:#C678DD">endfunction</span></span></code></pre></div>
<h2 id="silent-execution" class="mb-8 mt-4 pt-4 [&#38;_a]:text-primary [&#38;_a]:border-0 [&#38;_a]:before:content-['#'] [&#38;_a]:before:text-xl [&#38;_a]:before:ml-2">Silent execution<a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" aria-hidden="true" tabindex="-1" href="#silent-execution"><span class="icon icon-link"></span></a></h2>
<p>I also make the command execute silently, so I won’t be interrupted by
hit-enter prompts and error messages will not show up in the message history:</p>
<div data-codeblock class="last:mb-0" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div data-codeblock-header class="dark flex items-center gap-2 rounded-t py-1 bg-[var(--code-bg)] text-[var(--code-fg)] border-b border-divider" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div class="flex pl-2 items-center gap-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><svg viewBox="0 0 128 128" width="1em" height="1em"><path fill="currentColor" d="M72.6 80.5c.2.2.6.5.9.5h5.3c.3 0 .7-.3.9-.5l1.4-1.5c.2-.2.3-.4.3-.6l1.5-5.1c.1-.5 0-1-.3-1.3l-1.1-.9c-.2-.2-.6-.1-.9-.1h-4.8l-.2-.2-.1-.1c-.2 0-.4-.1-.6.1L73 72c-.2 0-.3.5-.4.7L71 77.6c-.2.5-.1 1.1.3 1.5l1.3 1.4zm.8 26.4-.4.1h-1.2L79 85.9c.2-.7-.1-1.5-.8-1.7l-.4-.1H65.7c-.5.1-.9.5-1 1l-.7 2.5c-.2.7.3 1.3 1 1.5l.3-.1h1.8l-7.3 20.9c-.2.7.1 1.6.8 1.9l.4.3h11.2c.6 0 1.1-.5 1.3-1.1l.7-2.4c.3-.7-.1-1.5-.8-1.7zm53.1-19.7-1.9-2.5v-.1c-.3-.3-.6-.6-1-.6h-7.2c-.4 0-.7.4-1 .6l-2 2.4h-3.1l-2.1-2.4v-.1c-.2-.3-.6-.5-1-.5h-4l20.2-20.2-22.6-22.4L121 20.6v-9L118.2 8H77.3L74 11.5v2.9L62.7 3 55 10.5 52.6 8H12.2L9 11.7v9.4l3 2.9h3v26.1l-14 14 14 14v32l5.2 2.9h11.6l9.1-9.5 21.6 21.6L77 110.6c.1.4.4.5.9.7l.4-.2h9.4c.6 0 1.1-.1 1.2-.6l.7-2c.2-.7-.1-1.3-.8-1.5l-.4.1H88l3.4-10.7 2.3-2.3h5l-5 15.9c-.2.7.2 1.1.9 1.4l.4-.2h9.1c.5 0 1-.1 1.2-.6l.8-1.8c.3-.7-.1-1.3-.7-1.6-.1-.1-.3 0-.5 0h-.4l4.2-13h6.1l-5.1 15.9c-.2.7.2 1.1.9 1.3l.4-.3h10c.5 0 1-.1 1.2-.6l.8-2c.3-.7-.1-1.3-.8-1.5-.1-.1-.3.1-.5.1h-.7l5.6-18.5c.2-.5.1-1.1-.1-1.4zM62.7 4.9 74 16.2v4.7l3.4 4.1H79L50 53V25h3.3l2.7-4.2v-8.9l-.2-.3 6.9-6.7zM2.9 64.1 15 52v24.2L2.9 64.1zm38.9 38.3 58.4-60 21.4 21.5-20.2 20.2h-.1c-.3.1-.5.3-.7.5L98.5 87h-2.9l-2.2-2.4c-.2-.3-.6-.6-1-.6h-8.8c-.6 0-1.1.4-1.3 1l-.8 2.5c-.2.7.1 1.3.8 1.6h1.5L77.4 108l-15.1 15.2-20.5-20.8z"></path></svg><div class="rtl truncate font-mono" style="--code-bg: #282c34;--code-fg: #abb2bf;">vim</div></div><div class="ml-auto flex flex-row gap-2 [&_svg]:h-6 [&_svg]:w-6 pr-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><astro-island uid="1mMz9A" prefix="r39" component-url="/_astro/CopyCodeBlockButton.c533e2fc.js" component-export="default" renderer-url="/_astro/client.74da55d9.js" props="{&quot;successText&quot;:[0,&quot;Copied!&quot;],&quot;errorText&quot;:[0,&quot;Failed to copy&quot;],&quot;code&quot;:[0,&quot;function! s:Format(...)\n  silent keepjumps normal! &#39;[v&#39;]gq\nendfunction\n&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;CopyCodeBlockButton&quot;,&quot;value&quot;:true}" await-children=""><button type="button" aria-label="Copy code" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 rounded border border-divider p-1 shadow-sm shadow-shadow"><span class="text-[var(--code-fg)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg></span></button><!--astro:end--></astro-island></div></div><pre class="shiki shadow-sm shadow-shadow rounded-b overflow-x-auto bg-[var(--code-bg)] text-[var(--code-fg)] [color-scheme:dark] [&#38;_code]:py-4 [&#38;_code]:grid [&#38;_code>.line]:px-8 [&#38;_code>.line]:border-l-[2px] [&#38;_code>.line]:border-[var(--code-bg)] [&#38;_code>.line.highlight]:bg-[#272115] [&#38;_code>.line.highlight]:border-[#624710] [&#38;_.error]:text-sm [&#38;_.error]:px-8 [&#38;_.error]:py-1 [&#38;_.popover]:my-2 [&#38;_.popover]:rounded-sm [&#38;_.popover]:bg-gray-700 [&#38;_.popover]:text-white [&#38;_.arrow]:bg-gray-700 [&#38;_.arrow]:border-gray-700" style="--code-bg: #282c34;--code-fg: #abb2bf;"><code class="language-vim" metastring="{2}"><span class="line"><span style="color:#C678DD">function</span><span style="color:#ABB2BF">! </span><span style="color:#61AFEF">s:Format</span><span style="color:#ABB2BF">(...)</span></span><span class="line highlight"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">silent</span><span style="color:#ABB2BF"> keepjumps </span><span style="color:#C678DD">normal</span><span style="color:#ABB2BF">! </span><span style="color:#98C379">&#39;[v&#39;</span><span style="color:#ABB2BF">]gq</span></span><span class="line"><span style="color:#C678DD">endfunction</span></span></code></pre></div>
<h2 id="error-handling" class="mb-8 mt-4 pt-4 [&#38;_a]:text-primary [&#38;_a]:border-0 [&#38;_a]:before:content-['#'] [&#38;_a]:before:text-xl [&#38;_a]:before:ml-2">Error handling<a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" aria-hidden="true" tabindex="-1" href="#error-handling"><span class="icon icon-link"></span></a></h2>
<p>The external program might fail to format the file — e.g. there is a syntax
error and <code>prettier</code> refuses to format it. The default experience is bad
because your code will be replaced by error messages, which is absolutely not
something anyone would want.</p>
<p><a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" href="https://gist.github.com/romainl/d2ad868afd7520519057475bd8e9db0c">I originally learned about how to work around this in a GitHub gist by
romainl</a>:</p>
<div data-codeblock class="last:mb-0" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div data-codeblock-header class="dark flex items-center gap-2 rounded-t py-1 bg-[var(--code-bg)] text-[var(--code-fg)] border-b border-divider" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div class="flex pl-2 items-center gap-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><svg viewBox="0 0 128 128" width="1em" height="1em"><path fill="currentColor" d="M72.6 80.5c.2.2.6.5.9.5h5.3c.3 0 .7-.3.9-.5l1.4-1.5c.2-.2.3-.4.3-.6l1.5-5.1c.1-.5 0-1-.3-1.3l-1.1-.9c-.2-.2-.6-.1-.9-.1h-4.8l-.2-.2-.1-.1c-.2 0-.4-.1-.6.1L73 72c-.2 0-.3.5-.4.7L71 77.6c-.2.5-.1 1.1.3 1.5l1.3 1.4zm.8 26.4-.4.1h-1.2L79 85.9c.2-.7-.1-1.5-.8-1.7l-.4-.1H65.7c-.5.1-.9.5-1 1l-.7 2.5c-.2.7.3 1.3 1 1.5l.3-.1h1.8l-7.3 20.9c-.2.7.1 1.6.8 1.9l.4.3h11.2c.6 0 1.1-.5 1.3-1.1l.7-2.4c.3-.7-.1-1.5-.8-1.7zm53.1-19.7-1.9-2.5v-.1c-.3-.3-.6-.6-1-.6h-7.2c-.4 0-.7.4-1 .6l-2 2.4h-3.1l-2.1-2.4v-.1c-.2-.3-.6-.5-1-.5h-4l20.2-20.2-22.6-22.4L121 20.6v-9L118.2 8H77.3L74 11.5v2.9L62.7 3 55 10.5 52.6 8H12.2L9 11.7v9.4l3 2.9h3v26.1l-14 14 14 14v32l5.2 2.9h11.6l9.1-9.5 21.6 21.6L77 110.6c.1.4.4.5.9.7l.4-.2h9.4c.6 0 1.1-.1 1.2-.6l.7-2c.2-.7-.1-1.3-.8-1.5l-.4.1H88l3.4-10.7 2.3-2.3h5l-5 15.9c-.2.7.2 1.1.9 1.4l.4-.2h9.1c.5 0 1-.1 1.2-.6l.8-1.8c.3-.7-.1-1.3-.7-1.6-.1-.1-.3 0-.5 0h-.4l4.2-13h6.1l-5.1 15.9c-.2.7.2 1.1.9 1.3l.4-.3h10c.5 0 1-.1 1.2-.6l.8-2c.3-.7-.1-1.3-.8-1.5-.1-.1-.3.1-.5.1h-.7l5.6-18.5c.2-.5.1-1.1-.1-1.4zM62.7 4.9 74 16.2v4.7l3.4 4.1H79L50 53V25h3.3l2.7-4.2v-8.9l-.2-.3 6.9-6.7zM2.9 64.1 15 52v24.2L2.9 64.1zm38.9 38.3 58.4-60 21.4 21.5-20.2 20.2h-.1c-.3.1-.5.3-.7.5L98.5 87h-2.9l-2.2-2.4c-.2-.3-.6-.6-1-.6h-8.8c-.6 0-1.1.4-1.3 1l-.8 2.5c-.2.7.1 1.3.8 1.6h1.5L77.4 108l-15.1 15.2-20.5-20.8z"></path></svg><div class="rtl truncate font-mono" style="--code-bg: #282c34;--code-fg: #abb2bf;">vim</div></div><div class="ml-auto flex flex-row gap-2 [&_svg]:h-6 [&_svg]:w-6 pr-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><astro-island uid="1sEGOq" prefix="r40" component-url="/_astro/CopyCodeBlockButton.c533e2fc.js" component-export="default" renderer-url="/_astro/client.74da55d9.js" props="{&quot;successText&quot;:[0,&quot;Copied!&quot;],&quot;errorText&quot;:[0,&quot;Failed to copy&quot;],&quot;code&quot;:[0,&quot;function! s:Format(...)\n  silent keepjumps normal! &#39;[v&#39;]gq\n  if v:shell_error &gt; 0\n    silent undo\n    echohl ErrorMsg\n    echomsg &#39;formatprg \&quot;&#39; . &amp;formatprg . &#39;\&quot; exited with status &#39; . v:shell_error\n    echohl None\n  endif\nendfunction\n&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;CopyCodeBlockButton&quot;,&quot;value&quot;:true}" await-children=""><button type="button" aria-label="Copy code" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 rounded border border-divider p-1 shadow-sm shadow-shadow"><span class="text-[var(--code-fg)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg></span></button><!--astro:end--></astro-island></div></div><pre class="shiki shadow-sm shadow-shadow rounded-b overflow-x-auto bg-[var(--code-bg)] text-[var(--code-fg)] [color-scheme:dark] [&#38;_code]:py-4 [&#38;_code]:grid [&#38;_code>.line]:px-8 [&#38;_code>.line]:border-l-[2px] [&#38;_code>.line]:border-[var(--code-bg)] [&#38;_code>.line.highlight]:bg-[#272115] [&#38;_code>.line.highlight]:border-[#624710] [&#38;_.error]:text-sm [&#38;_.error]:px-8 [&#38;_.error]:py-1 [&#38;_.popover]:my-2 [&#38;_.popover]:rounded-sm [&#38;_.popover]:bg-gray-700 [&#38;_.popover]:text-white [&#38;_.arrow]:bg-gray-700 [&#38;_.arrow]:border-gray-700" style="--code-bg: #282c34;--code-fg: #abb2bf;"><code class="language-vim" metastring="{3-7}"><span class="line"><span style="color:#C678DD">function</span><span style="color:#ABB2BF">! </span><span style="color:#61AFEF">s:Format</span><span style="color:#ABB2BF">(...)</span></span><span class="line"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">silent</span><span style="color:#ABB2BF"> keepjumps </span><span style="color:#C678DD">normal</span><span style="color:#ABB2BF">! </span><span style="color:#98C379">&#39;[v&#39;</span><span style="color:#ABB2BF">]gq</span></span><span class="line highlight"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> v:shell_error &gt; </span><span style="color:#D19A66">0</span></span><span class="line highlight"><span style="color:#ABB2BF">    </span><span style="color:#C678DD">silent</span><span style="color:#ABB2BF"> undo</span></span><span class="line highlight"><span style="color:#ABB2BF">    </span><span style="color:#56B6C2">echohl</span><span style="color:#ABB2BF"> ErrorMsg</span></span><span class="line highlight"><span style="color:#ABB2BF">    echomsg </span><span style="color:#98C379">&#39;formatprg &quot;&#39;</span><span style="color:#ABB2BF"> . &amp;formatprg . </span><span style="color:#98C379">&#39;&quot; exited with status &#39;</span><span style="color:#ABB2BF"> . v:shell_error</span></span><span class="line highlight"><span style="color:#ABB2BF">    </span><span style="color:#56B6C2">echohl</span><span style="color:#ABB2BF"> None</span></span><span class="line"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">endif</span></span><span class="line"><span style="color:#C678DD">endfunction</span></span></code></pre></div>
<p>After <code>gq</code> is used, we can check if an error occurred during the executing of
<code>formatprg</code> with the <code>v:shell_error</code> special variable, which holds the
program’s exit code. If it’s non-zero, it means the command failed so we undo
the operation and show up an error message.</p>
<h2 id="format-file-preserving-cursor-position" class="mb-8 mt-4 pt-4 [&#38;_a]:text-primary [&#38;_a]:border-0 [&#38;_a]:before:content-['#'] [&#38;_a]:before:text-xl [&#38;_a]:before:ml-2">Format file preserving cursor position<a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" aria-hidden="true" tabindex="-1" href="#format-file-preserving-cursor-position"><span class="icon icon-link"></span></a></h2>
<p>I also learned this from <a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" href="https://gist.github.com/romainl/d2ad868afd7520519057475bd8e9db0c">romainl’s GitHub
gist</a>.</p>
<p>The procedure remains almost unchanged, if only slightly refactored into one
function, mapped to <code>gQ</code>:</p>
<div data-codeblock class="last:mb-0" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div data-codeblock-header class="dark flex items-center gap-2 rounded-t py-1 bg-[var(--code-bg)] text-[var(--code-fg)] border-b border-divider" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div class="flex pl-2 items-center gap-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><svg viewBox="0 0 128 128" width="1em" height="1em"><path fill="currentColor" d="M72.6 80.5c.2.2.6.5.9.5h5.3c.3 0 .7-.3.9-.5l1.4-1.5c.2-.2.3-.4.3-.6l1.5-5.1c.1-.5 0-1-.3-1.3l-1.1-.9c-.2-.2-.6-.1-.9-.1h-4.8l-.2-.2-.1-.1c-.2 0-.4-.1-.6.1L73 72c-.2 0-.3.5-.4.7L71 77.6c-.2.5-.1 1.1.3 1.5l1.3 1.4zm.8 26.4-.4.1h-1.2L79 85.9c.2-.7-.1-1.5-.8-1.7l-.4-.1H65.7c-.5.1-.9.5-1 1l-.7 2.5c-.2.7.3 1.3 1 1.5l.3-.1h1.8l-7.3 20.9c-.2.7.1 1.6.8 1.9l.4.3h11.2c.6 0 1.1-.5 1.3-1.1l.7-2.4c.3-.7-.1-1.5-.8-1.7zm53.1-19.7-1.9-2.5v-.1c-.3-.3-.6-.6-1-.6h-7.2c-.4 0-.7.4-1 .6l-2 2.4h-3.1l-2.1-2.4v-.1c-.2-.3-.6-.5-1-.5h-4l20.2-20.2-22.6-22.4L121 20.6v-9L118.2 8H77.3L74 11.5v2.9L62.7 3 55 10.5 52.6 8H12.2L9 11.7v9.4l3 2.9h3v26.1l-14 14 14 14v32l5.2 2.9h11.6l9.1-9.5 21.6 21.6L77 110.6c.1.4.4.5.9.7l.4-.2h9.4c.6 0 1.1-.1 1.2-.6l.7-2c.2-.7-.1-1.3-.8-1.5l-.4.1H88l3.4-10.7 2.3-2.3h5l-5 15.9c-.2.7.2 1.1.9 1.4l.4-.2h9.1c.5 0 1-.1 1.2-.6l.8-1.8c.3-.7-.1-1.3-.7-1.6-.1-.1-.3 0-.5 0h-.4l4.2-13h6.1l-5.1 15.9c-.2.7.2 1.1.9 1.3l.4-.3h10c.5 0 1-.1 1.2-.6l.8-2c.3-.7-.1-1.3-.8-1.5-.1-.1-.3.1-.5.1h-.7l5.6-18.5c.2-.5.1-1.1-.1-1.4zM62.7 4.9 74 16.2v4.7l3.4 4.1H79L50 53V25h3.3l2.7-4.2v-8.9l-.2-.3 6.9-6.7zM2.9 64.1 15 52v24.2L2.9 64.1zm38.9 38.3 58.4-60 21.4 21.5-20.2 20.2h-.1c-.3.1-.5.3-.7.5L98.5 87h-2.9l-2.2-2.4c-.2-.3-.6-.6-1-.6h-8.8c-.6 0-1.1.4-1.3 1l-.8 2.5c-.2.7.1 1.3.8 1.6h1.5L77.4 108l-15.1 15.2-20.5-20.8z"></path></svg><div class="rtl truncate font-mono" style="--code-bg: #282c34;--code-fg: #abb2bf;">vim</div></div><div class="ml-auto flex flex-row gap-2 [&_svg]:h-6 [&_svg]:w-6 pr-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><astro-island uid="Z11IH2A" prefix="r41" component-url="/_astro/CopyCodeBlockButton.c533e2fc.js" component-export="default" renderer-url="/_astro/client.74da55d9.js" props="{&quot;successText&quot;:[0,&quot;Copied!&quot;],&quot;errorText&quot;:[0,&quot;Failed to copy&quot;],&quot;code&quot;:[0,&quot;function! s:FormatFile() abort\n  let w:view = winsaveview()\n  keepjumps normal! gg\n  set operatorfunc=&lt;SID&gt;Format\n  keepjumps normal! g@G\n  keepjumps call winrestview(w:view)\n  unlet w:view\nendfunction\n\nnmap &lt;silent&gt; gQ :call &lt;SID&gt;FormatFile()&lt;CR&gt;\n&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;CopyCodeBlockButton&quot;,&quot;value&quot;:true}" await-children=""><button type="button" aria-label="Copy code" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 rounded border border-divider p-1 shadow-sm shadow-shadow"><span class="text-[var(--code-fg)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg></span></button><!--astro:end--></astro-island></div></div><pre class="shiki shadow-sm shadow-shadow rounded-b overflow-x-auto bg-[var(--code-bg)] text-[var(--code-fg)] [color-scheme:dark] [&#38;_code]:py-4 [&#38;_code]:grid [&#38;_code>.line]:px-8 [&#38;_code>.line]:border-l-[2px] [&#38;_code>.line]:border-[var(--code-bg)] [&#38;_code>.line.highlight]:bg-[#272115] [&#38;_code>.line.highlight]:border-[#624710] [&#38;_.error]:text-sm [&#38;_.error]:px-8 [&#38;_.error]:py-1 [&#38;_.popover]:my-2 [&#38;_.popover]:rounded-sm [&#38;_.popover]:bg-gray-700 [&#38;_.popover]:text-white [&#38;_.arrow]:bg-gray-700 [&#38;_.arrow]:border-gray-700" style="--code-bg: #282c34;--code-fg: #abb2bf;"><code class="language-vim"><span class="line"><span style="color:#C678DD">function</span><span style="color:#ABB2BF">! </span><span style="color:#61AFEF">s:FormatFile</span><span style="color:#ABB2BF">() </span><span style="color:#C678DD">abort</span></span><span class="line"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">let</span><span style="color:#ABB2BF"> w:view = </span><span style="color:#61AFEF">winsaveview</span><span style="color:#ABB2BF">()</span></span><span class="line"><span style="color:#ABB2BF">  keepjumps </span><span style="color:#C678DD">normal</span><span style="color:#ABB2BF">! gg</span></span><span class="line"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">set</span><span style="color:#ABB2BF"> operatorfunc=&lt;</span><span style="color:#D19A66">SID</span><span style="color:#ABB2BF">&gt;Format</span></span><span class="line"><span style="color:#ABB2BF">  keepjumps </span><span style="color:#C678DD">normal</span><span style="color:#ABB2BF">! g@G</span></span><span class="line"><span style="color:#ABB2BF">  keepjumps </span><span style="color:#C678DD">call</span><span style="color:#ABB2BF"> </span><span style="color:#61AFEF">winrestview</span><span style="color:#ABB2BF">(w:view)</span></span><span class="line"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">unlet</span><span style="color:#ABB2BF"> w:view</span></span><span class="line"><span style="color:#C678DD">endfunction</span></span><span class="line"><span> </span></span><span class="line"><span style="color:#C678DD">nmap</span><span style="color:#ABB2BF"> &lt;</span><span style="color:#D19A66">silent</span><span style="color:#ABB2BF">&gt; gQ :</span><span style="color:#C678DD">call</span><span style="color:#ABB2BF"> &lt;</span><span style="color:#D19A66">SID</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF">FormatFile</span><span style="color:#ABB2BF">()&lt;</span><span style="color:#D19A66">CR</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></div>
<p>It consists of saving the current window view with <code>:h winsaveview()</code>, running
the operator as usual but moving over the entire file with <code>ggg@G</code> (but tries
not to modify the jumplist), then restore the window view with <code>:h winrestview()</code>.</p>
<h2 id="integration-with-cocnvim" class="mb-8 mt-4 pt-4 [&#38;_a]:text-primary [&#38;_a]:border-0 [&#38;_a]:before:content-['#'] [&#38;_a]:before:text-xl [&#38;_a]:before:ml-2">Integration with coc.nvim<a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" aria-hidden="true" tabindex="-1" href="#integration-with-cocnvim"><span class="icon icon-link"></span></a></h2>
<p>Since I use <a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" href="https://github.com/neoclide/coc.nvim"><code>coc.nvim</code></a> as my LSP
client, I wish I could reuse <code>gq</code> to format using LSP, if it was available.</p>
<p>It turns out it was surprisingly simple to implement it:</p>
<div data-codeblock class="last:mb-0" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div data-codeblock-header class="dark flex items-center gap-2 rounded-t py-1 bg-[var(--code-bg)] text-[var(--code-fg)] border-b border-divider" style="--code-bg: #282c34;--code-fg: #abb2bf;"><div class="flex pl-2 items-center gap-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><svg viewBox="0 0 128 128" width="1em" height="1em"><path fill="currentColor" d="M72.6 80.5c.2.2.6.5.9.5h5.3c.3 0 .7-.3.9-.5l1.4-1.5c.2-.2.3-.4.3-.6l1.5-5.1c.1-.5 0-1-.3-1.3l-1.1-.9c-.2-.2-.6-.1-.9-.1h-4.8l-.2-.2-.1-.1c-.2 0-.4-.1-.6.1L73 72c-.2 0-.3.5-.4.7L71 77.6c-.2.5-.1 1.1.3 1.5l1.3 1.4zm.8 26.4-.4.1h-1.2L79 85.9c.2-.7-.1-1.5-.8-1.7l-.4-.1H65.7c-.5.1-.9.5-1 1l-.7 2.5c-.2.7.3 1.3 1 1.5l.3-.1h1.8l-7.3 20.9c-.2.7.1 1.6.8 1.9l.4.3h11.2c.6 0 1.1-.5 1.3-1.1l.7-2.4c.3-.7-.1-1.5-.8-1.7zm53.1-19.7-1.9-2.5v-.1c-.3-.3-.6-.6-1-.6h-7.2c-.4 0-.7.4-1 .6l-2 2.4h-3.1l-2.1-2.4v-.1c-.2-.3-.6-.5-1-.5h-4l20.2-20.2-22.6-22.4L121 20.6v-9L118.2 8H77.3L74 11.5v2.9L62.7 3 55 10.5 52.6 8H12.2L9 11.7v9.4l3 2.9h3v26.1l-14 14 14 14v32l5.2 2.9h11.6l9.1-9.5 21.6 21.6L77 110.6c.1.4.4.5.9.7l.4-.2h9.4c.6 0 1.1-.1 1.2-.6l.7-2c.2-.7-.1-1.3-.8-1.5l-.4.1H88l3.4-10.7 2.3-2.3h5l-5 15.9c-.2.7.2 1.1.9 1.4l.4-.2h9.1c.5 0 1-.1 1.2-.6l.8-1.8c.3-.7-.1-1.3-.7-1.6-.1-.1-.3 0-.5 0h-.4l4.2-13h6.1l-5.1 15.9c-.2.7.2 1.1.9 1.3l.4-.3h10c.5 0 1-.1 1.2-.6l.8-2c.3-.7-.1-1.3-.8-1.5-.1-.1-.3.1-.5.1h-.7l5.6-18.5c.2-.5.1-1.1-.1-1.4zM62.7 4.9 74 16.2v4.7l3.4 4.1H79L50 53V25h3.3l2.7-4.2v-8.9l-.2-.3 6.9-6.7zM2.9 64.1 15 52v24.2L2.9 64.1zm38.9 38.3 58.4-60 21.4 21.5-20.2 20.2h-.1c-.3.1-.5.3-.7.5L98.5 87h-2.9l-2.2-2.4c-.2-.3-.6-.6-1-.6h-8.8c-.6 0-1.1.4-1.3 1l-.8 2.5c-.2.7.1 1.3.8 1.6h1.5L77.4 108l-15.1 15.2-20.5-20.8z"></path></svg><div class="rtl truncate font-mono" style="--code-bg: #282c34;--code-fg: #abb2bf;">vim</div></div><div class="ml-auto flex flex-row gap-2 [&_svg]:h-6 [&_svg]:w-6 pr-2" style="--code-bg: #282c34;--code-fg: #abb2bf;"><astro-island uid="Z2exuu" prefix="r42" component-url="/_astro/CopyCodeBlockButton.c533e2fc.js" component-export="default" renderer-url="/_astro/client.74da55d9.js" props="{&quot;successText&quot;:[0,&quot;Copied!&quot;],&quot;errorText&quot;:[0,&quot;Failed to copy&quot;],&quot;code&quot;:[0,&quot;function! s:Format(type, ...)\n  if CocHasProvider(&#39;formatRange&#39;)\n    call CocAction(&#39;formatSelected&#39;, a:type)\n    return\n  endif\n\n  \&quot; ...\nendfunction\n&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;CopyCodeBlockButton&quot;,&quot;value&quot;:true}" await-children=""><button type="button" aria-label="Copy code" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 rounded border border-divider p-1 shadow-sm shadow-shadow"><span class="text-[var(--code-fg)]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg></span></button><!--astro:end--></astro-island></div></div><pre class="shiki shadow-sm shadow-shadow rounded-b overflow-x-auto bg-[var(--code-bg)] text-[var(--code-fg)] [color-scheme:dark] [&#38;_code]:py-4 [&#38;_code]:grid [&#38;_code>.line]:px-8 [&#38;_code>.line]:border-l-[2px] [&#38;_code>.line]:border-[var(--code-bg)] [&#38;_code>.line.highlight]:bg-[#272115] [&#38;_code>.line.highlight]:border-[#624710] [&#38;_.error]:text-sm [&#38;_.error]:px-8 [&#38;_.error]:py-1 [&#38;_.popover]:my-2 [&#38;_.popover]:rounded-sm [&#38;_.popover]:bg-gray-700 [&#38;_.popover]:text-white [&#38;_.arrow]:bg-gray-700 [&#38;_.arrow]:border-gray-700" style="--code-bg: #282c34;--code-fg: #abb2bf;"><code class="language-vim"><span class="line"><span style="color:#C678DD">function</span><span style="color:#ABB2BF">! </span><span style="color:#61AFEF">s:Format</span><span style="color:#ABB2BF">(type, ...)</span></span><span class="line"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> </span><span style="color:#61AFEF">CocHasProvider</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;formatRange&#39;</span><span style="color:#ABB2BF">)</span></span><span class="line"><span style="color:#ABB2BF">    </span><span style="color:#C678DD">call</span><span style="color:#ABB2BF"> </span><span style="color:#61AFEF">CocAction</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;formatSelected&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75">a:type</span><span style="color:#ABB2BF">)</span></span><span class="line"><span style="color:#ABB2BF">    </span><span style="color:#C678DD">return</span></span><span class="line"><span style="color:#ABB2BF">  </span><span style="color:#C678DD">endif</span></span><span class="line"><span> </span></span><span class="line"><span style="color:#7F848E">  &quot; ...</span></span><span class="line"><span style="color:#C678DD">endfunction</span></span></code></pre></div>
<p>As you can see, I first check if check if the current buffer has an LSP server
attached to it and is able to format text ranges with the <code>CocHasProvider</code>
function.</p>
<p>I then use the <code>formatSelected</code> action, which receives the type of visual mode
last used (either <code>line</code>, <code>char</code> or <code>block</code>, the output of <code>:h visualmode()</code>),
which fortunately the <code>operatorfunc</code> function also receives as the first
argument (see <code>:h :map-operator</code>).</p></div></div></article><hr class="max-sm:full-bleed mt-8"><nav class="flex items-stretch sm:gap-4 max-sm:full-bleed sm:my-8" aria-label="Posts navigation"><a class="sm:card flex flex-1 flex-col gap-2 border-0 px-horizontal-padding py-4 transition-colors duration-300 hover:bg-hover" href="/posts/surprising-react-bug"><span class="text-primary"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><line x1="19" x2="5" y1="12" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></span>An apparent React bug</a><div class="border-l border-divider sm:hidden"></div><a class="sm:card flex flex-1 flex-col-reverse items-end justify-end gap-2 border-0 px-horizontal-padding py-4 text-right transition-colors duration-300 hover:bg-hover" href="/posts/template-string-converter-with-neovim-treesitter">Template String Converter in Neovim with Treesitter<span class="text-primary"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><line x1="5" x2="19" y1="12" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span></a></nav><hr class="max-sm:full-bleed mb-8"></div></main><footer class="border-t border-divider bg-background sm:border-0"><div class="mx-auto flex w-full max-w-content flex-col items-center px-horizontal-padding pt-4 pb-8 sm:justify-between"><nav aria-label="Contacts" class="flex gap-2 mb-2"><a id="contact-email" href="mailto:phelipe_teles@hotmail.com" aria-label="E-mail" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 min-w-[40px] h-[40px] flex justify-center items-center rounded-full px-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg></a><a id="contact-linkedin" href="https://linkedin.com/in/phelipeteles" aria-label="LinkedIn" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 min-w-[40px] h-[40px] flex justify-center items-center rounded-full px-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-linkedin"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a id="contact-github" href="https://github.com/phelipetls" aria-label="GitHub" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary transition-colors duration-300 min-w-[40px] h-[40px] flex justify-center items-center rounded-full px-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg></a></nav><span class="text-center">
Todo conteúdo está sob a licença <a class="underline underline-offset-4 decoration-primary hover:decoration-primary-hover" rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0</a>.
</span></div></footer></body></html>