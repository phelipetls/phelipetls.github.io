<!DOCTYPE html>
<html class="h-full" lang="en">
  <head>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="description" content="The way we&rsquo;ll get this to work is by using a generic Language Server called efm-langserver, which is written in Go." />
<meta name="deploy-date" content="2022-02-01">
<meta name="publish-date" content="2020-12-28">
<meta name="last-modified-date" content="2020-12-28">
<meta name="author" content="">
<meta name="color-scheme" content="dark light">


<link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Merriweather" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather" />






  
  
  


<link rel="stylesheet" href="/css/main.min.css" />
<link rel="stylesheet" href="/css/light-syntax-highlight.min.css" />
<link rel="stylesheet" href="/css/dark-syntax-highlight.min.css" disabled />

<title>
  Configuring eslint to work with Neovim LSP | Phelipe Teles
</title>



<meta property="og:title" content="Configuring eslint to work with Neovim LSP" />
<meta property="og:description" content="The way we&rsquo;ll get this to work is by using a generic Language Server called efm-langserver, which is written in Go." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://phelipetls.github.io/posts/configuring-eslint-to-work-with-neovim-lsp/" />
<meta property="article:published_time" content="2020-12-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-12-28T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Configuring eslint to work with Neovim LSP"/>
<meta name="twitter:description" content="The way we&rsquo;ll get this to work is by using a generic Language Server called efm-langserver, which is written in Go."/>



    
      
    
  </head>

  <body class="px-4 py-8 preload text-normal bg-background flex flex-col container max-w-2xl min-h-full mx-auto transition transition-colors duration-75 ease-out" data-theme="light">
    

    
      
    

    <script>window.__setTheme = function(newTheme) {
  document.body.setAttribute("data-theme", newTheme);
  localStorage.setItem("__theme", newTheme);
  const oldTheme = newTheme === "dark" ? "light" : "dark";
  document
    .querySelector("link[href*='" + oldTheme + "']")
    .setAttribute("disabled", "");
  document
    .querySelector("link[href*='" + newTheme + "']")
    .removeAttribute("disabled");
};

const storedTheme = localStorage.getItem("__theme");

if (storedTheme) {
  window.__setTheme(storedTheme);
} else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
  window.__setTheme("dark");
}

/* Enable animations */
window.addEventListener("load", function() {
  document.body.classList.remove("preload")
})
</script>

    <header class="mb-16">
  <h1 class="mb-4">
    <div class="flex justify-between">
      <a class="border-0 font-bold" href="https://phelipetls.github.io/">
        Phelipe Teles
      </a>

      <button
        id="theme-button"
        class="text-background bg-primary rounded-lg px-1 ring-divider ring-offset-background focus:ring-offset-2 focus:ring-2"
        aria-label="Change theme"
      >
        <svg width="24" height="24" viewBox="0 0 24 24">
          <defs>
            <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><title>Moon</title><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>

            <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><title>Sun</title><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>

          </defs>

          <use id="theme-button-svg-icon" href="#sun" />
        </svg>
      </button>
    </div>
  </h1>

  

  <nav class="flex flex-row flex-wrap gap-2" aria-label="Main navigation"><a
        id=""
        class="text-normal "
        href="https://phelipetls.github.io/"
      >
        About
      </a><a
        id=""
        class="text-normal "
        href="https://phelipetls.github.io/posts/"
      >
        Posts
      </a><a
        id=""
        class="text-normal "
        href="https://phelipetls.github.io/projects/"
      >
        Projects
      </a><a
        id=""
        class="text-normal "
        href="https://phelipetls.github.io/resume/phelipe-teles-resume.pdf"
      >
        Resumé
      </a></nav>
</header>


    <main class="flex flex-1 flex-col">
      
  <article>
    <h1>Configuring eslint to work with Neovim LSP</h1>

    <time datetime="2020-12-28">
      Dec 28, 2020
    </time>

    <div class="sm:flex gap-2 mt-4">
      
  
    <a href="/tags/lua/"class="inline-flex items-center gap-1 no-underline rounded px-3 border border-divider hover:bg-highlight hover:text-background">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag" style="display: inline;"><title>Tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
lua</a>
  
    <a href="/tags/nvim/"class="inline-flex items-center gap-1 no-underline rounded px-3 border border-divider hover:bg-highlight hover:text-background">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag" style="display: inline;"><title>Tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
nvim</a>
  
    <a href="/tags/lsp/"class="inline-flex items-center gap-1 no-underline rounded px-3 border border-divider hover:bg-highlight hover:text-background">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag" style="display: inline;"><title>Tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
lsp</a>
  
    <a href="/tags/eslint/"class="inline-flex items-center gap-1 no-underline rounded px-3 border border-divider hover:bg-highlight hover:text-background">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag" style="display: inline;"><title>Tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
eslint</a>
  


    </div>

    <hr class="my-8" />

    <p>The way we&rsquo;ll get this to work is by using a generic Language Server called
<a href="https://github.com/mattn/efm-langserver"><code>efm-langserver</code></a>, which is written in
Go.</p>
<p>These Language Servers are generic in that they were made to be powered by
command-line tools and for any programming language.</p>
<h2 class="group pt-3" id="making-eslint-faster-with-eslint_d">
  Making eslint faster with eslint_d
  <a class="hidden text-highlight group-hover:inline" href="#making-eslint-faster-with-eslint_d">#</a>
</h2>
<p>To reduce latency when invoking <code>eslint</code>, I&rsquo;m gonna use
<a href="https://github.com/mantoni/eslint_d.js/"><code>eslint_d</code></a>, which runs <code>eslint</code> as a
daemon process.</p>
<h2 class="group pt-3" id="configuring-eslint_d-in-efm-langserver">
  Configuring eslint_d in efm-langserver
  <a class="hidden text-highlight group-hover:inline" href="#configuring-eslint_d-in-efm-langserver">#</a>
</h2>
<p>It&rsquo;s possible to configure it with a YAML file, by following their README. I did
this initially I found that it&rsquo;s more powerful to configure it with Lua.</p>
<p>Here&rsquo;s the configuration, which more explanation below.</p>
<div class="highlight"><pre class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">lspconfig</span> <span class="o">=</span> <span class="n">require</span><span class="s2">&#34;lspconfig&#34;</span>

<span class="kd">local</span> <span class="n">eslint</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">lintCommand</span> <span class="o">=</span> <span class="s2">&#34;eslint_d -f unix --stdin --stdin-filename ${INPUT}&#34;</span><span class="p">,</span>
  <span class="n">lintStdin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
  <span class="n">lintFormats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;%f:%l:%c: %m&#34;</span><span class="p">},</span>
  <span class="n">lintIgnoreExitCode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
  <span class="n">formatCommand</span> <span class="o">=</span> <span class="s2">&#34;eslint_d --fix-to-stdout --stdin --stdin-filename=${INPUT}&#34;</span><span class="p">,</span>
  <span class="n">formatStdin</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="n">lspconfig.tsserver</span><span class="p">.</span><span class="n">setup</span> <span class="p">{</span>
  <span class="n">on_attach</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="kr">if</span> <span class="n">client.config</span><span class="p">.</span><span class="n">flags</span> <span class="kr">then</span>
      <span class="n">client.config</span><span class="p">.</span><span class="n">flags.allow_incremental_sync</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="kr">end</span>
    <span class="n">client.resolved_capabilities</span><span class="p">.</span><span class="n">document_formatting</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="n">set_lsp_config</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
  <span class="kr">end</span>
<span class="p">}</span>

<span class="n">lspconfig.efm</span><span class="p">.</span><span class="n">setup</span> <span class="p">{</span>
  <span class="n">on_attach</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="n">client.resolved_capabilities</span><span class="p">.</span><span class="n">document_formatting</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">client.resolved_capabilities</span><span class="p">.</span><span class="n">goto_definition</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="n">set_lsp_config</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
  <span class="kr">end</span><span class="p">,</span>
  <span class="n">root_dir</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">eslint_config_exists</span><span class="p">()</span> <span class="kr">then</span>
      <span class="kr">return</span> <span class="kc">nil</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="n">vim.fn</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span>
  <span class="kr">end</span><span class="p">,</span>
  <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">languages</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">javascript</span> <span class="o">=</span> <span class="p">{</span><span class="n">eslint</span><span class="p">},</span>
      <span class="n">javascriptreact</span> <span class="o">=</span> <span class="p">{</span><span class="n">eslint</span><span class="p">},</span>
      <span class="p">[</span><span class="s2">&#34;javascript.jsx&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">eslint</span><span class="p">},</span>
      <span class="n">typescript</span> <span class="o">=</span> <span class="p">{</span><span class="n">eslint</span><span class="p">},</span>
      <span class="p">[</span><span class="s2">&#34;typescript.tsx&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">eslint</span><span class="p">},</span>
      <span class="n">typescriptreact</span> <span class="o">=</span> <span class="p">{</span><span class="n">eslint</span><span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">filetypes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&#34;javascript&#34;</span><span class="p">,</span>
    <span class="s2">&#34;javascriptreact&#34;</span><span class="p">,</span>
    <span class="s2">&#34;javascript.jsx&#34;</span><span class="p">,</span>
    <span class="s2">&#34;typescript&#34;</span><span class="p">,</span>
    <span class="s2">&#34;typescript.tsx&#34;</span><span class="p">,</span>
    <span class="s2">&#34;typescriptreact&#34;</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div><p>I defined a table to configure <code>efm-langserver</code> with <code>eslint_d</code> by giving the
necessary commands for linting and formatting.</p>
<p>I customize the <code>on_attach</code> function of both <code>efm</code> and <code>tsserver</code> so that only
one has <code>documentFormatting</code> capability, otherwise they would conflict with each
other.</p>
<p>The <code>root_dir</code> function was also customized so that <code>eslint_d</code> is spawned just
for the current working directory and not for every directory it encounters a
<code>.eslintrc</code> (or similar).</p>
<p>But I also want this to happen only if the directory has some sort of <code>eslint</code>
configuration. So I created a function to do this:</p>
<div class="highlight"><pre class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">eslint_config_exists</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">eslintrc</span> <span class="o">=</span> <span class="n">vim.fn</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&#34;.eslintrc*&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

  <span class="kr">if</span> <span class="ow">not</span> <span class="n">vim.tbl_isempty</span><span class="p">(</span><span class="n">eslintrc</span><span class="p">)</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="kc">true</span>
  <span class="kr">end</span>

  <span class="kr">if</span> <span class="n">vim.fn</span><span class="p">.</span><span class="n">filereadable</span><span class="p">(</span><span class="s2">&#34;package.json&#34;</span><span class="p">)</span> <span class="kr">then</span>
    <span class="kr">if</span> <span class="n">vim.fn</span><span class="p">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">vim.fn</span><span class="p">.</span><span class="n">readfile</span><span class="p">(</span><span class="s2">&#34;package.json&#34;</span><span class="p">))[</span><span class="s2">&#34;eslintConfig&#34;</span><span class="p">]</span> <span class="kr">then</span>
      <span class="kr">return</span> <span class="kc">true</span>
    <span class="kr">end</span>
  <span class="kr">end</span>

  <span class="kr">return</span> <span class="kc">false</span>
<span class="kr">end</span>
</code></pre></div><h2 class="group pt-3" id="conclusion">
  Conclusion
  <a class="hidden text-highlight group-hover:inline" href="#conclusion">#</a>
</h2>
<p>This is kind like a poor replacement for the VS Code eslint extension, which
does a similar thing as <code>eslint_d</code>. And it works ok, it&rsquo;s pretty fast, much
faster than <code>typescript-language-server</code>, so it&rsquo;s definitely an improvement.</p>
<p>It would be nice if there was a way to shut down the server if <code>eslint</code> is
broken for example, but I didn&rsquo;t manage to do it just yet.</p>


    <hr class="my-8" />

    <nav aria-label="Posts navigation">
      <div class="float-left sm:max-w-1/2 flex group gap-2">
        
          <div class="group-hover:text-highlight">
            ←
          </div>

          <a class="border-0" href="/posts/f-strings-syntax-highlighting-in-vim/" title="Previous post">
            Python f-strings syntax highlighting in Vim
          </a>
        
      </div>

      <div class="float-right text-right mt-2 sm:mt-0 sm:max-w-1/2 flex group justify-end gap-2">
        
          <a class="border-0" href="/posts/migrating-from-cra-to-vite/" title="Next post">
            Migrating from create-react-app to Vite
          </a>

          <div class="group-hover:text-highlight">
            →
          </div>
        
      </div>
    </nav>
  </article>

    </main>

    <footer class="mt-16 text-center">
  <div>
    Icons by <a class="text-primary" href="https://feathericons.com/">Feather Icons</a>
  </div>

  <div>All content is under the
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
  Creative Commons Attribution 4.0
</a>
license
</div>
</footer>


    

    

    
      
    

    <script src="https://phelipetls.github.io/js/toggle-theme.js"></script>

    
    
  </body>
</html>
